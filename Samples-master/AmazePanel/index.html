<!doctype html>
<!--
/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
* Copyright 2020 Adobe
* All Rights Reserved.
*
* NOTICE: Adobe permits you to use, modify, and distribute this file in
* accordance with the terms of the Adobe license agreement accompanying
* it. If you have received this file from a source other than Adobe,
* then your use, modification, or distribution of it requires the prior
* written permission of Adobe. 
**************************************************************************/
-->
<html>

<head>
    <meta charset="utf-8">
    <title>AmazePanel</title>
    <script src="./ext.js"></script>
    <script src="./lib/CSInterface.js"></script>
    <script src="./lib/jquery-1.9.1.js"></script>
    <script src="./lib/Vulcan.js"></script>
    <link id="ppstyle" href="css/style.css" rel="stylesheet" type="text/css">
    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #1f1f1f;
            --panel-strong: #252525;
            --border: #303030;
            --muted: #8f8f8f;
            --text: #d8d8d8;
            --accent: #ff9b42;
            --accent-strong: #d74e00;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.45);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35);
            gap: 8px;
            flex-shrink: 0;
        }

        .title-block h1 {
            margin: 0;
            font-size: 14px;
            color: #eee;
            letter-spacing: 0.3px;
        }


        .tab-bar {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: #333;
            border: 1px solid #444;
            color: var(--text);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.2px;
            transition: all 0.12s ease;
            font-size: 10.5px;
        }

        .tab-btn:hover {
            background: #3d3d3d;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #111;
            border-color: var(--accent);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }

        .status-bar {
            display: flex;
            gap: 8px;
            padding: 10px 16px 0;
            flex-wrap: wrap;
            color: var(--muted);
            font-size: 11px;
        }

        .status-chip {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--text);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid #444;
            background: #666;
        }

        .status-dot.match {
            background: #2ecc71;
            border-color: #1f8f55;
        }

        .status-dot.mismatch {
            background: #e74c3c;
            border-color: #ad2f23;
        }

        .status-dot.neutral {
            background: #666;
            border-color: #444;
        }

        /* Emphasize the active sequence name */
        #active_seq {
            font-size: 13px;
            font-weight: 700;
        }

        .status-bar .pill-btn {
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
        }

        #content {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .tab-panel {
            display: none;
            flex: 1;
            min-height: 0;
            overflow: auto;
            padding: 16px;
        }

        .tab-panel.active {
            display: flex;
            flex-direction: column;
        }

        .panel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            align-content: start;
        }

        .panel-card {
            background: linear-gradient(145deg, var(--panel), var(--panel-strong));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            box-shadow: var(--shadow);
        }

        .panel-card h2 {
            margin: 0 0 8px;
            letter-spacing: 0.4px;
            font-size: 14px;
            color: #ededed;
        }

        .card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .muted {
            color: var(--muted);
            margin: 0;
            font-size: 12px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        button {
            background: #333;
            border: 1px solid #4a4a4a;
            color: #f2f2f2;
            padding: 10px 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.12s ease;
            text-align: left;
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            height: auto;
            min-height: 38px;
            line-height: 1.2;
        }

        button:hover {
            background: #3c3c3c;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.45);
        }

        button:active {
            transform: translateY(1px);
        }

        .pill-btn {
            border-radius: 999px;
            padding: 4px 8px;
            background: #262626;
            border-color: #3d3d3d;
            color: var(--text);
            font-size: 10.5px;
        }

        .pill-btn.primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #111;
            border-color: var(--accent);
        }

        .path-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .path-chip {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            padding: 8px 10px;
            border-radius: 10px;
            color: #eaeaea;
            min-width: 220px;
            font-size: 12px;
        }

        .render-queue {
            margin-top: 0;
            border: 1px solid #3c3c3c;
            border-radius: 12px;
            padding: 12px 14px 16px;
            background: #181818;
            box-shadow: var(--shadow);
        }

        .queue-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .queue-btn {
            min-width: 220px;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 14px;
            background: linear-gradient(135deg, #2e8bff, #1f6ad7);
            border: 1px solid #0f4fb2;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s ease;
        }

        .queue-btn.alt {
            background: linear-gradient(135deg, #ff9b42, #ff7a18);
            border: 1px solid #d95f00;
        }

        .queue-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
            opacity: 0.95;
        }

        .queue-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        #tab-showflow .panel-card {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: none;
            background: none;
            box-shadow: none;
            padding: 0;
        }

        #showflowFrame {
            border: 1px solid var(--border);
            border-radius: 12px;
            flex: 1;
            width: 100%;
            min-height: 0;
            background: #111;
            box-shadow: var(--shadow);
        }

        .ghost-drag {
            display: none;
        }

        a.inline-link {
            color: var(--accent);
            text-decoration: none;
        }

        a.inline-link:hover {
            text-decoration: underline;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(function () {
            function activateTab(tab) {
                $(".tab-btn").removeClass("active");
                $(".tab-btn[data-tab='" + tab + "']").addClass("active");
                $(".tab-panel").removeClass("active");
                $("#tab-" + tab).addClass("active");
            }

            $(".tab-btn").on("click", function () {
                activateTab($(this).data("tab"));
            });

            $(".tab-jump").on("click", function () {
                activateTab($(this).data("tabTarget"));
            });

            function refreshSequenceInfo() {
                var csInterface = new CSInterface();
                csInterface.evalScript("$._PPP_.getActiveSequenceName()", myCallBackFunction);
            }

            // For functions which require interaction at the JavaScript level, we provide these JQuery-based
            // handlers, instead of directly invoking ExtendScript. This lets us pass data into the ExtendScript layer.
            function runAmazeScript(fileName) {
                var csInterface = new CSInterface();
                var extRoot = csInterface.getSystemPath(SystemPath.EXTENSION); // returns forward slashes
                var fullPath = extRoot + "/jsx/custom/" + fileName; // forward slashes are fine

                // Build safe evalFile call with error capture
                var escaped = fullPath.replace(/\\/g, "\\\\").replace(/\"/g, "\\\"");
                var jsxCall = '(function(){ ' +
                    'try { ' +
                    '  var f = new File("' + escaped + '"); ' +
                    '  var info = "path=" + f.fsName + " exists=" + f.exists; ' +
                    '  if (!f.exists) { return "ERR: missing file -> " + info; } ' +
                    '  var res; ' +
                    '  try { res = $.evalFile(f); } catch(evalErr) { ' +
                    '    var msg1 = (evalErr && evalErr.toString) ? evalErr.toString() : evalErr; ' +
                    '    var ln1 = (evalErr && evalErr.line) ? evalErr.line : "?"; ' +
                    '    return "ERR-EVAL: " + msg1 + " line=" + ln1 + " info=" + info; ' +
                    '  } ' +
                    '  return "ok: " + info + " res=" + res; ' +
                    '} catch(e) { ' +
                    '  var msg = (e && e.toString) ? e.toString() : e; ' +
                    '  var ln = (e && e.line) ? e.line : "?"; ' +
                    '  return "ERR: " + msg + " line=" + ln + " info=' + escaped + '"; ' +
                    '}' +
                    '})()';

                csInterface.evalScript(jsxCall, function (res) {
                    if (res && res.indexOf("ERR:") === 0) {
                        alert("Script error:\n" + res);
                    }
                });
            }

            $("#run_CreateDefFolders").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("01_Create_Def_folders.jsx");
            });

            $("#run_SetInOutByMarkers").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("03_Set_InOut_By_Markers.jsx");
            });

            $("#run_CalMarkDuration").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("04_Cal_Mark_Duration.jsx");
            });

            $("#run_BuildTestScene").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("07_BuildTestScene.jsx");
            });

            $("#run_BuildFromMedia").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("08_BuildFromMediaAndUpdateShowflow.jsx");
            });

            $("#run_UpdateShowflowTemp").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("09_UpdateShowflow_temp.jsx");
            });

            $("#run_RenderSelected").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("10_RenderSelected.jsx");
            });

            $("#run_QueueMarkersToAME").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("11_Queue_Markers_To_AME.jsx");
            });

            // ----- Flow JSON selector (panel layer) -----
            var CONFIG_FILE = "flow_config.json";
            var flowPathEl = $("#flowPath");
            var mediaPathEl = $("#mediaPath");
            var renderPresetEl = $("#renderPresetPath");
            var renderOutputEl = $("#renderOutputPath");
            var flowMatchEl = $("#flowMatchDot");
            var flowNameEl = $("#flow_file_name");
            var currentFlowName = "";

            function baseName(path) {
                if (!path) return "";
                var parts = path.split(/[\\/]/);
                return parts.length ? parts[parts.length - 1] : path;
            }

            function prefixKey(str) {
                if (!str) return "";
                return str.replace(/[^A-Za-z0-9]/g, "").slice(0, 4).toUpperCase();
            }

            window.refreshFlowMatchState = function () {
                var dot = flowMatchEl.get(0);
                var seqEl = document.getElementById("active_seq");
                if (!dot || !seqEl || !flowNameEl.length) return;

                var seqName = (seqEl.textContent || "").trim();
                flowNameEl.text(currentFlowName || "[not set]");

                dot.classList.remove("match", "mismatch", "neutral");

                if (!currentFlowName || !seqName || seqName === "[uninitialized]") {
                    dot.classList.add("neutral");
                    dot.title = "Waiting for sequence and flow";
                    return;
                }

                var match = prefixKey(seqName) === prefixKey(currentFlowName);
                dot.classList.add(match ? "match" : "mismatch");
                dot.title = match ? "Flow matches project prefix" : "Flow does not match project prefix";
            };

            function configPath() {
                var csInterface = new CSInterface();
                var osVersion = csInterface.getOSInformation();
                var isWin = osVersion && osVersion.indexOf("Windows") >= 0;
                var extRoot = csInterface.getSystemPath(SystemPath.EXTENSION);
                if (isWin) extRoot = extRoot.replace(/\//g, "\\\\");
                var sep = isWin ? "\\\\" : "/";
                return extRoot + sep + CONFIG_FILE;
            }

            function loadFlowConfig() {
                var path = configPath();
                var parsed = { flowPath: "", mediaDir: "", renderPreset: "", renderOutput: "" };
                var res = window.cep.fs.readFile(path);
                if (res.err === 0 && res.data) {
                    try {
                        var raw = JSON.parse(res.data);
                        if (raw) parsed = raw;
                    } catch (e) { }
                }
                flowPathEl.text(parsed.flowPath || "[not set]");
                mediaPathEl.text(parsed.mediaDir || "[not set]");
                renderPresetEl.text(parsed.renderPreset || "[not set]");
                renderOutputEl.text(parsed.renderOutput || "[not set]");
                currentFlowName = baseName(parsed.flowPath || "") || "";
                window.refreshFlowMatchState();
                return parsed;
            }

            function saveFlowConfig(cfg) {
                var path = configPath();
                var payload = JSON.stringify(cfg || {}, null, 2);
                window.cep.fs.writeFile(path, payload);
                loadFlowConfig(); // refresh display
            }

            $("#pickFlow").on("click", function (e) {
                e.preventDefault();
                var csInterface = new CSInterface();
                var startFolder = csInterface.getSystemPath(SystemPath.EXTENSION);
                var dlg = window.cep.fs.showOpenDialog(false, false, "Select showflow JSON", startFolder, ["json"]);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    current.flowPath = dlg.data[0];
                    saveFlowConfig(current);
                }
            });

            $("#clearFlow").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.flowPath = "";
                saveFlowConfig(current);
            });

            $("#pickMedia").on("click", function (e) {
                e.preventDefault();
                var dlg = window.cep.fs.showOpenDialog(false, true, "Select media folder", "", []);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    current.mediaDir = dlg.data[0];
                    saveFlowConfig(current);
                }
            });

            $("#clearMedia").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.mediaDir = "";
                saveFlowConfig(current);
            });

            $("#pickRenderPreset").on("click", function (e) {
                e.preventDefault();
                var dlg = window.cep.fs.showOpenDialog(false, false, "Select AME preset (.epr)", "", ["epr"]);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    current.renderPreset = dlg.data[0];
                    saveFlowConfig(current);
                }
            });

            $("#clearRenderPreset").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.renderPreset = "";
                saveFlowConfig(current);
            });

            $("#pickRenderOutput").on("click", function (e) {
                e.preventDefault();
                var dlg = window.cep.fs.showOpenDialog(false, true, "Select render output folder", "", []);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    current.renderOutput = dlg.data[0];
                    saveFlowConfig(current);
                }
            });

            $("#clearRenderOutput").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.renderOutput = "";
                saveFlowConfig(current);
            });

            // init flow display
            loadFlowConfig();

            $("#openViz").on("click", function (e) {
                e.preventDefault();
                activateTab("showflow");
            });

            $("#refreshShowflow").on("click", function (e) {
                e.preventDefault();
                var bust = Date.now();
                window.location.href = "refresh.html?ts=" + bust;
            });

            // Start on Showflow tab by default
            activateTab("showflow");
            // Sync active sequence when panel regains focus (helps when user switches sequences in PPro)
            window.addEventListener("focus", refreshSequenceInfo);
        });
    </script>
</head>

<body onLoad="onLoaded()" class="theme-showflow">
    <div id="header">
        <div class="title-block">
            <h1>AMAZE PANEL</h1>
        </div>
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="showflow">Showflow Editor</button>
            <button class="tab-btn" data-tab="settings">Folder Setting</button>
            <button class="tab-btn" data-tab="scripts">Scripts</button>
            <button class="tab-btn pill-btn" id="refreshShowflow">Refresh Panel</button>
        </div>
    </div>

    <div class="status-bar">
        <span class="status-chip">Active sequence: <span id="active_seq">[uninitialized]</span></span>
        <span class="status-chip">Showflow: <span id="flow_file_name">[not set]</span> <span class="status-dot neutral" id="flowMatchDot" title="Waiting for sequence and flow"></span></span>
        <button class="pill-btn" id="refreshSeq">Refresh active sequence</button>
    </div>

    <div id="content">
        <div class="tab-panel active" id="tab-showflow">
            <div class="panel-card">
                <iframe id="showflowFrame" src="showflow_viz.html" title="Showflow Visual Editor"></iframe>
            </div>
        </div>

        <div class="tab-panel" id="tab-scripts">
            <div class="panel-grid">
                <div class="panel-card">
                    <div class="card-head">
                        <div>
                            <h2>스크립트 퀵 런</h2>
                            <p class="muted">자주 쓰는 프리미어 작업을 한 번에 실행합니다.</p>
                        </div>
                        <button class="pill-btn primary" id="openViz">Showflow 보기</button>
                    </div>
                    <div class="button-grid">
                        <button class="controlBg textStyle" id="run_CreateDefFolders">Create default folders</button>
                        <button class="controlBg textStyle" id="run_SetInOutByMarkers">Set In/Out by markers</button>
                        <button class="controlBg textStyle" id="run_CalMarkDuration">Calc marker duration</button>
                        <button class="controlBg textStyle" id="run_BuildTestScene">Build test scene</button>
                        <button class="controlBg textStyle" id="run_BuildFromMedia">Build from media & update showflow</button>
                        <button class="controlBg textStyle" id="run_UpdateShowflowTemp">Update showflow (temp)</button>
                    </div>
                </div>

                <div class="panel-card render-queue">
                    <h2>Render queue</h2>
                    <div class="queue-actions">
                        <button class="queue-btn" id="run_RenderSelected">Render active sequence</button>
                        <button class="queue-btn alt" id="run_QueueMarkersToAME">Queue Markers to AME</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-panel" id="tab-settings">
            <div class="panel-grid">
                <div class="panel-card">
                    <h2>Flow file</h2>
                    <div class="path-row">
                        <span class="path-chip" id="flowPath">[not set]</span>
                    </div>
                    <div class="button-grid">
                        <button class="controlBg textStyle" id="pickFlow">Pick flow JSON</button>
                        <button class="controlBg textStyle" id="clearFlow">Clear</button>
                    </div>
                </div>

                <div class="panel-card">
                    <h2>Media folder</h2>
                    <div class="path-row">
                        <span class="path-chip" id="mediaPath">[not set]</span>
                    </div>
                    <div class="button-grid">
                        <button class="controlBg textStyle" id="pickMedia">Pick media folder</button>
                        <button class="controlBg textStyle" id="clearMedia">Clear</button>
                    </div>
                </div>

                <div class="panel-card">
                    <h2>Render</h2>
                    <div class="path-row">
                        <span class="path-chip">Preset: <span id="renderPresetPath">[not set]</span></span>
                    </div>
                    <div class="button-grid">
                        <button class="controlBg textStyle" id="pickRenderPreset">Pick preset (.epr)</button>
                        <button class="controlBg textStyle" id="clearRenderPreset">Clear preset</button>
                    </div>
                    <div class="path-row">
                        <span class="path-chip">Output: <span id="renderOutputPath">[not set]</span></span>
                    </div>
                    <div class="button-grid">
                        <button class="controlBg textStyle" id="pickRenderOutput">Pick output folder</button>
                        <button class="controlBg textStyle" id="clearRenderOutput">Clear output</button>
                    </div>
                </div>
            </div>
            <div id="dragthing" draggable="true" ondragstart="dragHandler(event)" class="ghost-drag">Drag and drop import</div>
        </div>
    </div>
</body>

</html>
