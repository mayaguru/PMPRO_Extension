<!doctype html>
<!--
/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
* Copyright 2020 Adobe
* All Rights Reserved.
*
* NOTICE: Adobe permits you to use, modify, and distribute this file in
* accordance with the terms of the Adobe license agreement accompanying
* it. If you have received this file from a source other than Adobe,
* then your use, modification, or distribution of it requires the prior
* written permission of Adobe. 
**************************************************************************/
-->
<html>

<head>
    <meta charset="utf-8">
    <title>AmazePanel</title>
    <script src="./ext.js"></script>
    <script src="./lib/CSInterface.js"></script>
    <script src="./lib/jquery-1.9.1.js"></script>
    <script src="./lib/Vulcan.js"></script>
    <link id="ppstyle" href="css/style.css" rel="stylesheet" type="text/css">
    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #1f1f1f;
            --panel-strong: #252525;
            --border: #303030;
            --muted: #8f8f8f;
            --text: #d8d8d8;
            --accent: #ff9b42;
            --accent-strong: #d74e00;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.45);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35);
        }

        .title-block h1 {
            margin: 0;
            font-size: 14px;
            color: #eee;
            letter-spacing: 0.3px;
        }


        .tab-bar {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: #333;
            border: 1px solid #444;
            color: var(--text);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.2px;
            transition: all 0.12s ease;
            font-size: 10.5px;
        }

        .tab-btn:hover {
            background: #3d3d3d;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #111;
            border-color: var(--accent);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }

        .status-bar {
            display: flex;
            gap: 8px;
            padding: 0;
            flex-wrap: wrap;
            color: var(--muted);
            font-size: 11px;
            align-items: center;
        }

        .status-chip {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--text);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid #444;
            background: #666;
        }

        .status-dot.match {
            background: #2ecc71;
            border-color: #1f8f55;
        }

        .status-dot.mismatch {
            background: #e74c3c;
            border-color: #ad2f23;
        }

        .status-dot.neutral {
            background: #666;
            border-color: #444;
        }

        /* Emphasize the active sequence name */
        #active_seq {
            font-size: 13px;
            font-weight: 700;
        }

        .status-refresh {
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .status-refresh button {
            padding: 4px 8px;
            min-width: auto;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }

        .icon-btn {
            width: 26px;
            height: 26px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            border-radius: 50%;
        }

        #content {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .tab-panel {
            display: none;
            flex: 1;
            min-height: 0;
            overflow: auto;
            padding: 16px;
        }

        .tab-panel.active {
            display: flex;
            flex-direction: column;
        }

        .panel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            align-content: start;
        }

        .panel-card {
            background: linear-gradient(145deg, var(--panel), var(--panel-strong));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            box-shadow: var(--shadow);
        }

        .panel-card h2 {
            margin: 0 0 8px;
            letter-spacing: 0.4px;
            font-size: 14px;
            color: #ededed;
        }

        #tab-backups .panel-card {
            max-width: 960px;
            margin: 0 auto;
        }

        .backup-card .backup-meta {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            font-size: 12px;
            color: var(--muted);
            padding: 6px 0 10px;
        }

        .backup-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 6px 0;
        }

        .backup-status {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .backup-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px dashed var(--border);
            border-radius: 8px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.15);
        }

        .backup-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #232323;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 8px 12px;
            gap: 12px;
        }

        .backup-info {
            flex: 1;
            min-width: 0;
        }

        .backup-name {
            font-weight: 600;
            color: #f0f0f0;
            word-break: break-all;
        }

        .backup-meta-text {
            font-size: 11px;
            color: var(--muted);
        }

        .backup-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .backup-empty {
            text-align: center;
            color: var(--muted);
            font-size: 12px;
            padding: 20px 0;
        }

        .card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .muted {
            color: var(--muted);
            margin: 0;
            font-size: 12px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        #tab-settings .button-pair {
            display: flex;
            gap: 8px;
        }

        #tab-settings .button-pair button {
            flex: 1;
            padding: 6px 10px;
            min-height: 32px;
            font-size: 11px;
        }

        button {
            background: #333;
            border: 1px solid #4a4a4a;
            color: #f2f2f2;
            padding: 10px 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.12s ease;
            text-align: left;
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            height: auto;
            min-height: 38px;
            line-height: 1.2;
        }

        button:hover {
            background: #3c3c3c;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.45);
        }

        button:active {
            transform: translateY(1px);
        }

        .pill-btn {
            border-radius: 999px;
            padding: 4px 8px;
            background: #262626;
            border-color: #3d3d3d;
            color: var(--text);
            font-size: 10.5px;
        }

        .pill-btn.primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #111;
            border-color: var(--accent);
        }

        .pill-btn.ghost {
            background: transparent;
            border-color: #555;
            color: var(--muted);
        }

        .pill-btn.ghost:hover {
            color: var(--text);
        }

        .path-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .path-chip {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            padding: 8px 10px;
            border-radius: 10px;
            color: #eaeaea;
            min-width: 220px;
            font-size: 12px;
        }

        .render-queue {
            margin-top: 0;
            border: 1px solid #3c3c3c;
            border-radius: 12px;
            padding: 12px 14px 16px;
            background: #181818;
            box-shadow: var(--shadow);
        }

        .queue-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .queue-btn {
            min-width: 220px;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 14px;
            background: linear-gradient(135deg, #2e8bff, #1f6ad7);
            border: 1px solid #0f4fb2;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s ease;
        }

        .queue-btn.alt {
            background: linear-gradient(135deg, #ff9b42, #ff7a18);
            border: 1px solid #d95f00;
        }

        .queue-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
            opacity: 0.95;
        }

        .queue-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        #tab-showflow .panel-card {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: none;
            background: none;
            box-shadow: none;
            padding: 0;
        }

        #showflowFrame {
            border: 1px solid var(--border);
            border-radius: 12px;
            flex: 1;
            width: 100%;
            min-height: 0;
            background: #111;
            box-shadow: var(--shadow);
        }

        .ghost-drag {
            display: none;
        }

        a.inline-link {
            color: var(--accent);
            text-decoration: none;
        }

        a.inline-link:hover {
            text-decoration: underline;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(function () {
            function activateTab(tab) {
                $(".tab-btn").removeClass("active");
                $(".tab-btn[data-tab='" + tab + "']").addClass("active");
                $(".tab-panel").removeClass("active");
                $("#tab-" + tab).addClass("active");
                if (tab === "backups") {
                    refreshBackupList();
                }
            }

            $(".tab-btn").on("click", function () {
                activateTab($(this).data("tab"));
            });

            $(".tab-jump").on("click", function () {
                activateTab($(this).data("tabTarget"));
            });

            function refreshSequenceInfo() {
                var csInterface = new CSInterface();
                csInterface.evalScript("$._PPP_.getActiveSequenceName()", myCallBackFunction);
            }

            // For functions which require interaction at the JavaScript level, we provide these JQuery-based
            // handlers, instead of directly invoking ExtendScript. This lets us pass data into the ExtendScript layer.
            function runAmazeScript(fileName) {
                var csInterface = new CSInterface();
                var extRoot = csInterface.getSystemPath(SystemPath.EXTENSION); // returns forward slashes
                var fullPath = extRoot + "/jsx/custom/" + fileName; // forward slashes are fine

                // Build safe evalFile call with error capture
                var escaped = fullPath.replace(/\\/g, "\\\\").replace(/\"/g, "\\\"");
                var jsxCall = '(function(){ ' +
                    'try { ' +
                    '  var f = new File("' + escaped + '"); ' +
                    '  var info = "path=" + f.fsName + " exists=" + f.exists; ' +
                    '  if (!f.exists) { return "ERR: missing file -> " + info; } ' +
                    '  var res; ' +
                    '  try { res = $.evalFile(f); } catch(evalErr) { ' +
                    '    var msg1 = (evalErr && evalErr.toString) ? evalErr.toString() : evalErr; ' +
                    '    var ln1 = (evalErr && evalErr.line) ? evalErr.line : "?"; ' +
                    '    return "ERR-EVAL: " + msg1 + " line=" + ln1 + " info=" + info; ' +
                    '  } ' +
                    '  return "ok: " + info + " res=" + res; ' +
                    '} catch(e) { ' +
                    '  var msg = (e && e.toString) ? e.toString() : e; ' +
                    '  var ln = (e && e.line) ? e.line : "?"; ' +
                    '  return "ERR: " + msg + " line=" + ln + " info=' + escaped + '"; ' +
                    '}' +
                    '})()';

                csInterface.evalScript(jsxCall, function (res) {
                    if (res && res.indexOf("ERR:") === 0) {
                        alert("Script error:\n" + res);
                    }
                });
            }

            $("#run_CreateDefFolders").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("01_Create_Def_folders.jsx");
            });

            $("#run_SetInOutByMarkers").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("03_Set_InOut_By_Markers.jsx");
            });

            $("#run_CalMarkDuration").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("04_Cal_Mark_Duration.jsx");
            });

            $("#run_BuildTestScene").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("07_BuildTestScene.jsx");
            });

            $("#run_BuildFromMedia").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("08_BuildFromMediaAndUpdateShowflow.jsx");
            });

            $("#run_UpdateShowflowTemp").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("09_UpdateShowflow_temp.jsx");
            });

            $("#run_RenderSelected").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("10_RenderSelected.jsx");
            });

            $("#run_QueueMarkersToAME").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("11_Queue_Markers_To_AME.jsx");
            });

            $("#backup-refresh").on("click", function (e) {
                e.preventDefault();
                refreshBackupList();
            });

            $("#backup-open-folder").on("click", function (e) {
                e.preventDefault();
                openBackupFolder(backupFolderPath);
            });

            $("#backup-manual").on("click", function (e) {
                e.preventDefault();
                requestManualBackup();
            });

            $("#backup-list-panel").on("click", ".restore-btn", function (e) {
                e.preventDefault();
                var path = $(this).data("path");
                restoreBackupFile(path);
            });

            $("#backup-list-panel").on("click", ".reveal-btn", function (e) {
                e.preventDefault();
                var path = $(this).data("path");
                var folder = "";
                if (path && typeof path === "string") {
                    folder = path.replace(/[^\\/]+$/, "");
                }
                if (!folder) folder = backupFolderPath;
                openBackupFolder(folder);
            });

            // ----- Flow JSON selector (panel layer) -----
            var CONFIG_FILE = "flow_config.json";
            var flowPathEl = $("#flowPath");

            var renderPresetEl = $("#renderPresetPath");
            var renderOutputEl = $("#renderOutputPath");
            var flowMatchEl = $("#flowMatchDot");
            var flowNameEl = $("#flow_file_name");
            var currentFlowName = "";
            var backupFlowLabel = $("#backup-flow-path");
            var backupFolderLabel = $("#backup-folder-path");
            var backupListEl = $("#backup-list-panel");
            var backupStatusEl = $("#backup-status");
            var backupFlowPath = "";
            var backupFolderPath = "";

            function baseName(path) {
                if (!path) return "";
                var parts = path.split(/[\\/]/);
                return parts.length ? parts[parts.length - 1] : path;
            }

            function prefixKey(str) {
                if (!str) return "";
                return str.replace(/[^A-Za-z0-9]/g, "").slice(0, 4).toUpperCase();
            }

            window.refreshFlowMatchState = function () {
                var dot = flowMatchEl.get(0);
                var seqEl = document.getElementById("active_seq");
                if (!dot || !seqEl || !flowNameEl.length) return;

                var seqName = (seqEl.textContent || "").trim();
                flowNameEl.text(currentFlowName || "[not set]");
                flowNameEl.attr("title", backupFlowPath || "[not set]");

                dot.classList.remove("match", "mismatch", "neutral");

                if (!currentFlowName || !seqName || seqName === "[uninitialized]") {
                    dot.classList.add("neutral");
                    dot.title = "Waiting for sequence and flow";
                    return;
                }

                var match = prefixKey(seqName) === prefixKey(currentFlowName);
                dot.classList.add(match ? "match" : "mismatch");
                dot.title = match ? "Flow matches project prefix" : "Flow does not match project prefix";
            };

            function sanitizeBackupSegment(name) {
                var safe = (name || "flow").replace(/[<>:"/\\|?*\x00-\x1F]/g, "_");
                safe = safe.replace(/\s+/g, "_");
                if (!safe) safe = "flow";
                return safe;
            }

            function backupInfoFromFlowPath(flowPath) {
                if (!flowPath) return null;
                var usesBackslash = flowPath.indexOf("\\") >= 0;
                var normalized = flowPath.replace(/\\/g, "/");
                var lastSlash = normalized.lastIndexOf("/");
                var dir = lastSlash >= 0 ? normalized.substring(0, lastSlash) : "";
                var file = lastSlash >= 0 ? normalized.substring(lastSlash + 1) : normalized;
                var base = file.replace(/\.[^.]+$/, "");
                var safeBase = sanitizeBackupSegment(base);
                var folder = dir + "/__showflow_backups/" + safeBase;
                if (usesBackslash) {
                    folder = folder.replace(/\//g, "\\");
                }
                var sep = usesBackslash ? "\\" : "/";
                return {
                    folderPath: folder,
                    separator: sep,
                    fileName: file,
                    safeBase: safeBase
                };
            }

            function joinPaths(dir, child, sepOverride) {
                if (!dir) return child;
                var sep = sepOverride || (dir.indexOf("\\") >= 0 ? "\\" : "/");
                if (dir.endsWith("\\") || dir.endsWith("/")) {
                    return dir + child;
                }
                return dir + sep + child;
            }

            function parseBackupName(name) {
                var match = name.match(/__(\d{8}-\d{6})/);
                if (!match) {
                    return {
                        label: name,
                        sortValue: name.toLowerCase(),
                        iso: ""
                    };
                }
                var stamp = match[1]; // YYYYMMDD-HHMMSS
                var date = null;
                try {
                    var year = parseInt(stamp.substring(0, 4), 10);
                    var month = parseInt(stamp.substring(4, 6), 10) - 1;
                    var day = parseInt(stamp.substring(6, 8), 10);
                    var hour = parseInt(stamp.substring(9, 11), 10);
                    var min = parseInt(stamp.substring(11, 13), 10);
                    var sec = parseInt(stamp.substring(13, 15), 10);
                    date = new Date(year, month, day, hour, min, sec);
                } catch (e) {
                    date = null;
                }
                var label = date ? date.toLocaleString() : stamp;
                var sortValue = date ? date.getTime() : stamp;
                return {
                    label: label,
                    sortValue: sortValue,
                    iso: stamp
                };
            }

            function setBackupStatus(text) {
                if (!backupStatusEl || backupStatusEl.length === 0) return;
                backupStatusEl.text(text || "");
            }

            function updateBackupMeta(flowPath, overrideFolder) {
                backupFlowPath = flowPath || "";
                var info = backupInfoFromFlowPath(flowPath);
                backupFolderPath = overrideFolder || (info ? info.folderPath : "");
                if (backupFlowLabel && backupFlowLabel.length) {
                    backupFlowLabel.text(backupFlowPath || "[not set]");
                }
                if (backupFolderLabel && backupFolderLabel.length) {
                    backupFolderLabel.text(backupFolderPath || "[not created]");
                }
                if (flowNameEl && flowNameEl.length) {
                    flowNameEl.attr("title", backupFlowPath || "[not set]");
                }
            }

            function renderBackupEntries(entries) {
                if (!backupListEl || backupListEl.length === 0) return;
                if (!entries || entries.length === 0) {
                    backupListEl.html("<div class='backup-empty'>No backups found for this showflow yet.</div>");
                    return;
                }
                var html = entries.map(function (item) {
                    return "<div class='backup-row'>" +
                        "<div class='backup-info'>" +
                        "<div class='backup-name'>" + item.name + "</div>" +
                        "<div class='backup-meta-text'>" + item.label + "</div>" +
                        "</div>" +
                        "<div class='backup-actions'>" +
                        "<button class='pill-btn restore-btn' data-path=\"" + item.path.replace(/\"/g, "&quot;") + "\">Restore</button>" +
                        "<button class='pill-btn ghost reveal-btn' data-path=\"" + item.path.replace(/\"/g, "&quot;") + "\">Reveal</button>" +
                        "</div>" +
                        "</div>";
                }).join("");
                backupListEl.html(html);
            }

            function refreshBackupList() {
                var cfg = loadFlowConfig();
                var flowPath = (cfg && cfg.flowPath) ? cfg.flowPath : "";
                updateBackupMeta(flowPath);
                if (!flowPath) {
                    renderBackupEntries([]);
                    setBackupStatus("Pick a showflow file to enable backups.");
                    return;
                }
                var info = backupInfoFromFlowPath(flowPath);
                if (!info) {
                    renderBackupEntries([]);
                    setBackupStatus("Unable to determine backup folder.");
                    return;
                }
                var folderListing = window.cep.fs.readdir(info.folderPath);
                if (folderListing.err !== 0 || !folderListing.data || folderListing.data.length === 0) {
                    renderBackupEntries([]);
                    setBackupStatus("No backups saved yet.");
                    return;
                }
                var entries = folderListing.data.filter(function (name) {
                    return /\.json$/i.test(name);
                }).map(function (name) {
                    var parsed = parseBackupName(name);
                    return {
                        name: name,
                        label: parsed.label,
                        sortValue: parsed.sortValue,
                        path: joinPaths(info.folderPath, name, info.separator)
                    };
                }).sort(function (a, b) {
                    return b.sortValue - a.sortValue;
                });
                renderBackupEntries(entries);
                setBackupStatus(entries.length + " backup(s) available");
            }

            function openBackupFolder(path) {
                if (!path) {
                    alert("No backup folder available.");
                    return;
                }
                var jsx = "(function(){\n" +
                    "var folder = new Folder(decodeURIComponent('" + encodeURIComponent(path) + "'));\n" +
                    "if(!folder.exists){return 'missing';}\n" +
                    "try{folder.execute();return 'ok';}catch(e){return e.toString();}\n" +
                    "})();";
                var csInterface = new CSInterface();
                csInterface.evalScript(jsx, function (res) {
                    if (res !== "ok") {
                        alert("Unable to open folder: " + res);
                    }
                });
            }

            function requestManualBackup() {
                var frame = document.getElementById("showflowFrame");
                if (!frame || !frame.contentWindow) {
                    alert("Showflow editor is not available.");
                    return;
                }
                setBackupStatus("Requesting manual backup from editor…");
                try {
                    frame.contentWindow.postMessage({ type: "manual-backup-request" }, "*");
                } catch (e) {
                    alert("Failed to talk to editor: " + e);
                }
            }

            function restoreBackupFile(path) {
                if (!path) return;
                var cfg = loadFlowConfig();
                if (!cfg.flowPath) {
                    alert("No flow file configured.");
                    return;
                }
                if (!confirm("Restore this backup?\n\n" + path + "\n\nThis will overwrite the current flow file.")) {
                    return;
                }
                var contents = window.cep.fs.readFile(path);
                if (contents.err !== 0) {
                    alert("Could not read backup file.");
                    return;
                }
                var writeResult = window.cep.fs.writeFile(cfg.flowPath, contents.data);
                if (writeResult.err !== 0) {
                    alert("Failed to overwrite flow file.");
                    return;
                }
                setBackupStatus("Backup restored. Reloading editor…");
                var frame = document.getElementById("showflowFrame");
                if (frame && frame.contentWindow) {
                    frame.contentWindow.postMessage({ type: "reload-from-disk" }, "*");
                }
                alert("Backup restored successfully.");
            }

            function configPath() {
                var csInterface = new CSInterface();
                var osVersion = csInterface.getOSInformation();
                var isWin = osVersion && osVersion.indexOf("Windows") >= 0;
                var extRoot = csInterface.getSystemPath(SystemPath.EXTENSION);
                if (isWin) extRoot = extRoot.replace(/\//g, "\\\\");
                var sep = isWin ? "\\\\" : "/";
                return extRoot + sep + CONFIG_FILE;
            }

            function loadFlowConfig() {
                var path = configPath();
                var parsed = { flowPath: "", renderPreset: "", renderOutput: "" };
                var res = window.cep.fs.readFile(path);
                if (res.err === 0 && res.data) {
                    try {
                        var raw = JSON.parse(res.data);
                        if (raw) parsed = raw;
                    } catch (e) { }
                }
                flowPathEl.text(parsed.flowPath || "[not set]");

                renderPresetEl.text(parsed.renderPreset || "[not set]");
                renderOutputEl.text(parsed.renderOutput || "[not set]");
                updateBackupMeta(parsed.flowPath || "");
                currentFlowName = baseName(parsed.flowPath || "") || "";
                window.refreshFlowMatchState();
                return parsed;
            }

            function saveFlowConfig(cfg) {
                var path = configPath();
                var payload = JSON.stringify(cfg || {}, null, 2);
                window.cep.fs.writeFile(path, payload);
                loadFlowConfig(); // refresh display
            }

            $("#pickFlow").on("click", function (e) {
                e.preventDefault();
                var csInterface = new CSInterface();
                var startFolder = csInterface.getSystemPath(SystemPath.EXTENSION);
                var dlg = window.cep.fs.showOpenDialog(false, false, "Select showflow JSON", startFolder, ["json"]);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    current.flowPath = dlg.data[0];
                    saveFlowConfig(current);
                }
            });

            $("#clearFlow").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.flowPath = "";
                saveFlowConfig(current);
            });



            $("#pickRenderPreset").on("click", function (e) {
                e.preventDefault();
                var dlg = window.cep.fs.showOpenDialog(false, false, "Select AME preset (.epr)", "", ["epr"]);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    current.renderPreset = dlg.data[0];
                    saveFlowConfig(current);
                }
            });

            $("#clearRenderPreset").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.renderPreset = "";
                saveFlowConfig(current);
            });

            $("#pickRenderOutput").on("click", function (e) {
                e.preventDefault();
                var dlg = window.cep.fs.showOpenDialog(false, true, "Select render output folder", "", []);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    current.renderOutput = dlg.data[0];
                    saveFlowConfig(current);
                }
            });

            $("#clearRenderOutput").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.renderOutput = "";
                saveFlowConfig(current);
            });

            // init flow display
            loadFlowConfig();

            $("#openViz").on("click", function (e) {
                e.preventDefault();
                activateTab("showflow");
            });

            $("#refreshShowflow").on("click", function (e) {
                e.preventDefault();
                var bust = Date.now();
                window.location.href = "refresh.html?ts=" + bust;
            });

            var showflowFrame = document.getElementById("showflowFrame");
            if (showflowFrame) {
                showflowFrame.addEventListener("load", function () {
                    try {
                        showflowFrame.contentWindow.postMessage({ type: "request-flow-context" }, "*");
                    } catch (e) { }
                });
            }

            // Start on Showflow tab by default
            activateTab("showflow");
            // Sync active sequence when panel regains focus (helps when user switches sequences in PPro)
            window.addEventListener("focus", refreshSequenceInfo);

            window.addEventListener("message", function (event) {
                var data = event.data || {};
                if (data.type === "backup-created") {
                    var timeMsg = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : "just now";
                    setBackupStatus((data.mode === "manual" ? "Manual" : "Auto") + " backup saved at " + timeMsg);
                    refreshBackupList();
                } else if (data.type === "flow-context") {
                    updateBackupMeta(data.path || "", data.backupFolder || "");
                    if ($("#tab-backups").hasClass("active")) {
                        refreshBackupList();
                    }
                }
            });
        });
    </script>
</head>

<body onLoad="onLoaded()" class="theme-showflow">
    <div id="header">
        <div class="status-bar">
            <span class="status-chip" id="active-sequence-chip">
                <span id="active_seq">[uninitialized]</span>
            </span>
            <div class="status-refresh">
                <button class="pill-btn icon-btn" id="refreshSeq" title="Refresh active sequence"
                    aria-label="Refresh active sequence">&#x21bb;</button>
            </div>
            <span class="status-chip" id="flow-chip">
                <span id="flow_file_name">[not set]</span>
                <span class="status-dot neutral" id="flowMatchDot" title="Waiting for sequence and flow"></span>
            </span>
        </div>
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="showflow">Showflow Editor</button>
            <button class="tab-btn" data-tab="backups">Backups</button>
            <button class="tab-btn" data-tab="settings">Settings</button>
            <button class="tab-btn" data-tab="scripts">Scripts</button>
            <button class="tab-btn pill-btn icon-btn" id="refreshShowflow" title="Refresh Panel" aria-label="Refresh Panel">&#x267b;</button>
        </div>
    </div>

    <div id="content">
        <div class="tab-panel active" id="tab-showflow">
            <div class="panel-card">
                <iframe id="showflowFrame" src="showflow_viz.html" title="Showflow Visual Editor"></iframe>
            </div>
        </div>

        <div class="tab-panel" id="tab-backups">
            <div class="panel-card backup-card">
                <h2>Backup Center</h2>
                <p class="muted">Automatic backups run quietly; visit this page when you want to inspect or restore
                    history.</p>
                <div class="backup-meta">
                    <div>Active flow: <span id="backup-flow-path">[not set]</span></div>
                    <div>Backup folder: <span id="backup-folder-path">[not created]</span></div>
                </div>
                <div class="backup-controls">
                    <button class="pill-btn" id="backup-refresh">Refresh List</button>
                    <button class="pill-btn" id="backup-open-folder">Open Folder</button>
                    <button class="pill-btn primary" id="backup-manual">Manual Backup (ask editor)</button>
                </div>
                <div class="backup-status" id="backup-status">Waiting for editor…</div>
                <div class="backup-list" id="backup-list-panel"></div>
            </div>
        </div>

        <div class="tab-panel" id="tab-scripts">
            <div class="panel-grid">
                <div class="panel-card">
                    <div class="card-head">
                        <div>
                            <h2>스크립트 퀵 런</h2>
                            <p class="muted">자주 쓰는 프리미어 작업을 한 번에 실행합니다.</p>
                        </div>
                        <button class="pill-btn primary" id="openViz">Showflow 보기</button>
                    </div>
                    <div class="button-grid">
                        <button class="controlBg textStyle" id="run_CreateDefFolders">Create default folders</button>
                        <button class="controlBg textStyle" id="run_SetInOutByMarkers">Set In/Out by markers</button>
                        <button class="controlBg textStyle" id="run_CalMarkDuration">Calc marker duration</button>
                        <button class="controlBg textStyle" id="run_BuildTestScene">Build test scene</button>
                        <button class="controlBg textStyle" id="run_BuildFromMedia">Build from media & update
                            showflow</button>
                        <button class="controlBg textStyle" id="run_UpdateShowflowTemp">Update showflow (temp)</button>
                    </div>
                </div>

                <div class="panel-card render-queue">
                    <h2>Render queue</h2>
                    <div class="queue-actions">
                        <button class="queue-btn" id="run_RenderSelected">Render active sequence</button>
                        <button class="queue-btn alt" id="run_QueueMarkersToAME">Queue Markers to AME</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-panel" id="tab-settings">
            <div class="panel-grid">
                <div class="panel-card">
                    <h2>Flow file</h2>
                    <div class="path-row">
                        <span class="path-chip" id="flowPath">[not set]</span>
                    </div>
                    <div class="button-grid">
                        <div class="button-pair">
                            <button class="controlBg textStyle" id="pickFlow">Pick flow JSON</button>
                            <button class="controlBg textStyle" id="clearFlow">Clear</button>
                        </div>
                    </div>
                </div>



                <div class="panel-card">
                    <h2>Render</h2>
                    <div class="path-row">
                        <span class="path-chip">Preset: <span id="renderPresetPath">[not set]</span></span>
                    </div>
                    <div class="button-grid">
                        <div class="button-pair">
                            <button class="controlBg textStyle" id="pickRenderPreset">Pick preset (.epr)</button>
                            <button class="controlBg textStyle" id="clearRenderPreset">Clear preset</button>
                        </div>
                    </div>
                    <div class="path-row">
                        <span class="path-chip">Output: <span id="renderOutputPath">[not set]</span></span>
                    </div>
                    <div class="button-grid">
                        <div class="button-pair">
                            <button class="controlBg textStyle" id="pickRenderOutput">Pick output folder</button>
                            <button class="controlBg textStyle" id="clearRenderOutput">Clear output</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="dragthing" draggable="true" ondragstart="dragHandler(event)" class="ghost-drag">Drag and drop
                import</div>
        </div>
    </div>
</body>

</html>
