<!doctype html>
<!--
/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
* Copyright 2020 Adobe
* All Rights Reserved.
*
* NOTICE: Adobe permits you to use, modify, and distribute this file in
* accordance with the terms of the Adobe license agreement accompanying
* it. If you have received this file from a source other than Adobe,
* then your use, modification, or distribution of it requires the prior
* written permission of Adobe. 
**************************************************************************/
-->
<html>

<head>
    <meta charset="utf-8">
    <title>AmazePanel</title>
    <script src="./ext.js"></script>
    <script src="./lib/CSInterface.js"></script>
    <script src="./lib/jquery-1.9.1.js"></script>
    <script src="./lib/Vulcan.js"></script>
    <script src="./js/server_manager.js"></script>
    <link id="ppstyle" href="css/style.css" rel="stylesheet" type="text/css">
    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #1f1f1f;
            --panel-strong: #252525;
            --border: #303030;
            --muted: #8f8f8f;
            --text: #d8d8d8;
            --accent: #ff9b42;
            --accent-strong: #d74e00;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.45);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        .confirm-modal .modal-content {
            background: #2d2d2d;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 20px;
            max-width: 360px;
            width: 90%;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.55);
        }

        .confirm-modal h2 {
            margin: 0 0 10px;
            font-size: 16px;
            color: #f0f0f0;
        }

        .confirm-modal p {
            font-size: 13px;
            color: #ccc;
            line-height: 1.5;
            margin: 0 0 18px;
        }

        .confirm-modal .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        #header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35);
        }

        .title-block h1 {
            margin: 0;
            font-size: 14px;
            color: #eee;
            letter-spacing: 0.3px;
        }


        .tab-bar {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: #333;
            border: 1px solid #444;
            color: var(--text);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.2px;
            transition: all 0.12s ease;
            font-size: 10.5px;
        }

        .tab-btn:hover {
            background: #3d3d3d;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #111;
            border-color: var(--accent);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }

        .status-bar {
            display: flex;
            gap: 8px;
            padding: 0;
            flex-wrap: wrap;
            color: var(--muted);
            font-size: 11px;
            align-items: center;
        }

        .status-chip {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--text);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid #444;
            background: #666;
        }

        .status-dot.blink {
            animation: mismatch-blink 1s steps(2, jump-none) infinite;
        }

        .status-dot.match {
            background: #2ecc71;
            border-color: #1f8f55;
        }

        .status-dot.mismatch {
            background: #e74c3c;
            border-color: #ad2f23;
        }

        .status-dot.neutral {
            background: #666;
            border-color: #444;
        }

        @keyframes mismatch-blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 1;
            }
        }

        /* Emphasize the active sequence name */
        #active_seq {
            font-size: 13px;
            font-weight: 700;
        }

        .status-refresh {
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .status-refresh button {
            padding: 4px 8px;
            min-width: auto;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }

        .icon-btn {
            width: 26px;
            height: 26px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            border-radius: 50%;
        }

        .icon-btn.tiny {
            width: 22px;
            height: 22px;
            font-size: 11px;
        }

        .status-warning {
            display: none;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(231, 76, 60, 0.15);
            color: #ffb1a6;
            font-size: 11px;
            border: 1px solid rgba(231, 76, 60, 0.4);
            align-items: center;
            gap: 6px;
        }

        .status-warning.visible {
            display: inline-flex;
            animation: mismatch-blink 1.2s steps(2, jump-none) infinite;
        }

        #content {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .tab-panel {
            display: none;
            flex: 1;
            min-height: 0;
            overflow: auto;
            padding: 16px;
        }

        .tab-panel.active {
            display: flex;
            flex-direction: column;
        }

        .panel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            align-content: start;
        }

        .panel-card {
            background: linear-gradient(145deg, var(--panel), var(--panel-strong));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            box-shadow: var(--shadow);
        }

        .panel-card h2 {
            margin: 0 0 8px;
            letter-spacing: 0.4px;
            font-size: 14px;
            color: #ededed;
        }

        #tab-backups .panel-card {
            max-width: 960px;
            margin: 0 auto;
        }

        .backup-card .backup-meta {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            font-size: 12px;
            color: var(--muted);
            padding: 6px 0 10px;
        }

        .backup-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 6px 0;
        }

        .backup-settings {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .backup-settings label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .backup-settings select {
            background: #2d2d2d;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .backup-status {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .backup-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px dashed var(--border);
            border-radius: 8px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.15);
        }

        .backup-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #232323;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 8px 12px;
            gap: 12px;
        }

        .backup-info {
            flex: 1;
            min-width: 0;
        }

        .backup-name {
            font-weight: 600;
            color: #f0f0f0;
            word-break: break-all;
        }

        .backup-meta-text {
            font-size: 11px;
            color: var(--muted);
        }

        .backup-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .backup-empty {
            text-align: center;
            color: var(--muted);
            font-size: 12px;
            padding: 20px 0;
        }

        .card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .muted {
            color: var(--muted);
            margin: 0;
            font-size: 12px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        .quick-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-slot {
            display: flex;
            align-items: stretch;
            gap: 8px;
        }

        .quick-run-btn {
            display: flex;
            flex: 1;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }

        .quick-run-btn .quick-label {
            font-size: 12px;
            font-weight: 600;
        }

        .quick-run-btn .quick-path {
            font-size: 11px;
            color: var(--muted);
            word-break: break-all;
        }

        .quick-load-btn {
            width: 96px;
            min-width: 96px;
            justify-content: center;
            text-align: center;
            padding: 6px 10px;
        }

        #tab-settings .button-pair {
            display: flex;
            gap: 8px;
        }

        #tab-settings .button-pair button {
            flex: 1;
            padding: 6px 10px;
            min-height: 32px;
            font-size: 11px;
        }

        button {
            background: #333;
            border: 1px solid #4a4a4a;
            color: #f2f2f2;
            padding: 10px 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.12s ease;
            text-align: left;
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            height: auto;
            min-height: 38px;
            line-height: 1.2;
        }

        button:hover {
            background: #3c3c3c;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.45);
        }

        button:active {
            transform: translateY(1px);
        }

        .pill-btn {
            border-radius: 999px;
            padding: 4px 8px;
            background: #262626;
            border-color: #3d3d3d;
            color: var(--text);
            font-size: 10.5px;
        }

        .pill-btn.primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #111;
            border-color: var(--accent);
        }

        .pill-btn.ghost {
            background: transparent;
            border-color: #555;
            color: var(--muted);
        }

        .pill-btn.ghost:hover {
            color: var(--text);
        }

        .path-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .path-chip {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            padding: 8px 10px;
            border-radius: 10px;
            color: #eaeaea;
            min-width: 220px;
            font-size: 12px;
        }

        .render-queue {
            margin-top: 0;
            border: 1px solid #3c3c3c;
            border-radius: 12px;
            padding: 12px 14px 16px;
            background: #181818;
            box-shadow: var(--shadow);
        }

        .queue-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .queue-btn {
            min-width: 220px;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 14px;
            background: linear-gradient(135deg, #2e8bff, #1f6ad7);
            border: 1px solid #0f4fb2;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s ease;
        }

        .queue-btn.alt {
            background: linear-gradient(135deg, #ff9b42, #ff7a18);
            border: 1px solid #d95f00;
        }

        .queue-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
            opacity: 0.95;
        }

        .queue-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        #tab-showflow .panel-card {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: none;
            background: none;
            box-shadow: none;
            padding: 0;
        }

        #showflowFrame {
            border: 1px solid var(--border);
            border-radius: 12px;
            flex: 1;
            width: 100%;
            min-height: 0;
            background: #111;
            box-shadow: var(--shadow);
        }

        .ghost-drag {
            display: none;
        }

        a.inline-link {
            color: var(--accent);
            text-decoration: none;
        }

        a.inline-link:hover {
            text-decoration: underline;
        }

        .vr-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 14px;
            margin-bottom: 16px;
        }

        .vr-preview-panel {
            background: #151515;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .vr-preview-panel h3 {
            margin: 0;
        }

        .vr-preview-display {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #333;
            background: #000;
            aspect-ratio: var(--vr-preview-aspect, 16 / 9);
            min-height: 160px;
        }

        .vr-preview-display img,
        .vr-preview-display iframe {
            width: 100%;
            height: 100%;
            display: block;
            border: none;
            background: #000;
            object-fit: fill;
        }

        .vr-preview-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.68);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 13px;
            padding: 12px;
            pointer-events: none;
        }

        .vr-crop-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 2;
        }

        .vr-crop-overlay.disabled {
            opacity: 0.15;
        }

        .vr-crop-selection {
            position: absolute;
            border: 2px solid rgba(79, 195, 247, 0.9);
            background: rgba(79, 195, 247, 0.08);
            border-radius: 4px;
            cursor: move;
            pointer-events: auto;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.4);
        }

        .vr-crop-selection.hidden {
            display: none;
        }

        .vr-crop-center-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-left: 1px dashed rgba(255, 255, 255, 0.55);
            pointer-events: none;
        }

        .vr-crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(79, 195, 247, 0.95);
            border: 2px solid #0d1824;
            pointer-events: auto;
        }

        .vr-crop-handle.handle-nw {
            top: -6px;
            left: -6px;
            cursor: nwse-resize;
        }

        .vr-crop-handle.handle-ne {
            top: -6px;
            right: -6px;
            cursor: nesw-resize;
        }

        .vr-crop-handle.handle-sw {
            bottom: -6px;
            left: -6px;
            cursor: nesw-resize;
        }

        .vr-crop-handle.handle-se {
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
        }

        .vr-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 6px;
        }

        .vr-aspect-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .vr-aspect-row label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text);
        }

        .vr-aspect-row input[type="checkbox"] {
            accent-color: var(--accent);
            width: 16px;
            height: 16px;
        }

        .vr-aspect-note {
            font-size: 11px;
            color: var(--muted);
            flex: 1;
        }

        .vr-config-grid label {
            font-size: 11px;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .vr-config-grid input,
        .vr-config-grid select {
            background: #1e1e1e;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 8px;
            color: var(--text);
            font-size: 12px;
        }

        .vr-button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .vr-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 11px;
            color: var(--muted);
            margin-top: 10px;
        }

        .vr-status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 11px;
            border: 1px solid var(--border);
            background: #1f1f1f;
            color: var(--muted);
        }

        .vr-status-pill.online {
            border-color: #1f8f55;
            color: #2ecc71;
        }

        .vr-status-pill.offline {
            border-color: #ad2f23;
            color: #ff6b6b;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(function () {
            function activateTab(tab) {
                $(".tab-btn").removeClass("active");
                $(".tab-btn[data-tab='" + tab + "']").addClass("active");
                $(".tab-panel").removeClass("active");
                $("#tab-" + tab).addClass("active");
                if (tab === "backups") {
                    refreshBackupList();
                }
            }

            $(".tab-btn").on("click", function () {
                activateTab($(this).data("tab"));
            });

            $(".tab-jump").on("click", function () {
                activateTab($(this).data("tabTarget"));
            });

            function refreshSequenceInfo() {
                var csInterface = new CSInterface();
                csInterface.evalScript("$._PPP_.getActiveSequenceName()", myCallBackFunction);
            }

            var QUICK_SLOT_COUNT = 6;
            var quickScriptState = [];
            var quickPlaceholderText = "스크립트를 설정하세요.";
            var defaultVrConfig = {
                serverUrl: "http://localhost:5000",
                mode: "region",
                monitorIndex: 1,
                fps: 30,
                quality: 80,
                region: {
                    top: 0,
                    left: 0,
                    width: 1280,
                    height: 720
                },
                aspectLock: false
            };
            var currentVrConfig = JSON.parse(JSON.stringify(defaultVrConfig));
            var vrMonitors = [];
            var vrStatusTimer = null;
            var vrEls = {
                statusText: $("#vrStatusText"),
                statusChip: $("#vrStatusChip"),
                statusLabel: $("#vrStatusLabel"),
                previewImage: $("#vrPreviewImage"),
                previewOverlay: $("#vrPreviewOverlay"),
                cropOverlay: $("#vrCropOverlay"),
                cropSelection: $("#vrCropSelection"),
                frame: $("#vrFrame"),
                frameOverlay: $("#vrFrameOverlay"),
                serverUrl: $("#vrServerUrl"),
                modeSelect: $("#vrMode"),
                fpsInput: $("#vrFps"),
                qualityInput: $("#vrQuality"),
                monitorSelect: $("#vrMonitorIndex"),
                topInput: $("#vrTop"),
                leftInput: $("#vrLeft"),
                widthInput: $("#vrWidth"),
                heightInput: $("#vrHeight"),
                aspectLock: $("#vrAspectLock"),
                configStatus: $("#vrConfigStatus"),
                localIp: $("#vrLocalIp"),
                instructionIp: $("#local-ip-display")
            };
            var vrCropOverlayEl = document.getElementById("vrCropOverlay");
            var vrCropSelectionEl = document.getElementById("vrCropSelection");
            var cropOverlayRect = { x: 0, y: 0, width: 1, height: 1 };
            var cropDragState = { active: false, mode: "move" };

            function isAbsoluteScriptPath(path) {
                if (!path) return false;
                if (/^[a-zA-Z]:[\\/]/.test(path)) return true; // Windows drive
                if (path.indexOf("\\\\") === 0) return true; // Windows UNC
                return path.indexOf("/") === 0; // macOS/Unix
            }

            // For functions which require interaction at the JavaScript level, we provide these JQuery-based
            // handlers, instead of directly invoking ExtendScript. This lets us pass data into the ExtendScript layer.
            function runAmazeScript(fileName) {
                if (!fileName) {
                    alert("실행할 스크립트가 설정되지 않았습니다.");
                    return;
                }
                var csInterface = new CSInterface();
                var extRoot = csInterface.getSystemPath(SystemPath.EXTENSION); // returns forward slashes
                var fullPath = fileName;
                if (!isAbsoluteScriptPath(fullPath)) {
                    fullPath = extRoot + "/jsx/custom/" + fileName; // forward slashes are fine
                }

                // Build safe evalFile call with error capture
                var escaped = fullPath.replace(/\\/g, "\\\\").replace(/\"/g, "\\\"");
                var jsxCall = '(function(){ ' +
                    'try { ' +
                    '  var f = new File("' + escaped + '"); ' +
                    '  var info = "path=" + f.fsName + " exists=" + f.exists; ' +
                    '  if (!f.exists) { return "ERR: missing file -> " + info; } ' +
                    '  var res; ' +
                    '  try { res = $.evalFile(f); } catch(evalErr) { ' +
                    '    var msg1 = (evalErr && evalErr.toString) ? evalErr.toString() : evalErr; ' +
                    '    var ln1 = (evalErr && evalErr.line) ? evalErr.line : "?"; ' +
                    '    return "ERR-EVAL: " + msg1 + " line=" + ln1 + " info=" + info; ' +
                    '  } ' +
                    '  return "ok: " + info + " res=" + res; ' +
                    '} catch(e) { ' +
                    '  var msg = (e && e.toString) ? e.toString() : e; ' +
                    '  var ln = (e && e.line) ? e.line : "?"; ' +
                    '  return "ERR: " + msg + " line=" + ln + " info=' + escaped + '"; ' +
                    '}' +
                    '})()';

                csInterface.evalScript(jsxCall, function (res) {
                    if (res && res.indexOf("ERR:") === 0) {
                        alert("Script error:\n" + res);
                    }
                });
            }

            function refreshQuickRunUI(rawList) {
                quickScriptState = [];
                for (var i = 0; i < QUICK_SLOT_COUNT; i++) {
                    var entry = rawList && rawList[i] ? rawList[i] : null;
                    var path = entry && typeof entry.path === "string" ? entry.path : "";
                    var label = entry && entry.label ? entry.label : "";
                    if (!label && path) {
                        label = baseName(path);
                    }
                    var defaultLabel = "Slot " + (i + 1);
                    quickScriptState.push({
                        path: path,
                        label: label || defaultLabel
                    });
                    var runBtn = $("#quickRun" + i);
                    var labelEl = $("#quickLabel" + i);
                    var pathEl = $("#quickPath" + i);
                    if (labelEl.length) {
                        labelEl.text(path ? (label || defaultLabel) : defaultLabel);
                    }
                    if (pathEl.length) {
                        pathEl.text(path ? path : quickPlaceholderText);
                    }
                    if (runBtn.length) {
                        runBtn.prop("disabled", !path);
                        runBtn.attr("title", path ? path : quickPlaceholderText);
                    }
                }
            }

            function updateQuickSlotConfig(slotIndex, scriptPath) {
                if (slotIndex < 0 || slotIndex >= QUICK_SLOT_COUNT) return;
                var current = loadFlowConfig() || {};
                if (!Array.isArray(current.quickScripts)) {
                    current.quickScripts = [];
                }
                current.quickScripts[slotIndex] = scriptPath ? {
                    path: scriptPath,
                    label: baseName(scriptPath)
                } : null;
                saveFlowConfig(current);
            }

            function pickQuickScript(slotIndex) {
                var dlg = window.cep.fs.showOpenDialog(false, false, "Select JSX script", "", ["jsx"]);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    updateQuickSlotConfig(slotIndex, dlg.data[0]);
                }
            }

            for (var qs = 0; qs < QUICK_SLOT_COUNT; qs++) {
                (function (slotIndex) {
                    $("#quickRun" + slotIndex).on("click", function (e) {
                        e.preventDefault();
                        var selected = quickScriptState[slotIndex];
                        if (!selected || !selected.path) {
                            alert("이 슬롯에는 스크립트가 없습니다.");
                            return;
                        }
                        runAmazeScript(selected.path);
                    });

                    $("#quickLoad" + slotIndex).on("click", function (e) {
                        e.preventDefault();
                        if (e.shiftKey) {
                            updateQuickSlotConfig(slotIndex, "");
                            return;
                        }
                        pickQuickScript(slotIndex);
                    });
                })(qs);
            }

            $("#run_RenderSelected").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("10_RenderSelected.jsx");
            });

            $("#run_QueueMarkersToAME").on("click", function (e) {
                e.preventDefault();
                runAmazeScript("11_Queue_Markers_To_AME.jsx");
            });

            $("#backup-refresh").on("click", function (e) {
                e.preventDefault();
                refreshBackupList();
            });

            $("#backup-open-folder").on("click", function (e) {
                e.preventDefault();
                openBackupFolder(backupFolderPath);
            });

            $("#backup-manual").on("click", function (e) {
                e.preventDefault();
                requestManualBackup();
            });

            $("#backup-interval-select").on("change", function (e) {
                var minutes = parseInt($(this).val(), 10);
                if (isNaN(minutes)) minutes = 5;
                var frame = document.getElementById("showflowFrame");
                if (frame && frame.contentWindow) {
                    try {
                        frame.contentWindow.postMessage({ type: "set-backup-interval", minutes: minutes }, "*");
                    } catch (err) { }
                }
            });

            $("#backup-list-panel").on("click", ".restore-btn", function (e) {
                e.preventDefault();
                var path = $(this).data("path");
                restoreBackupFile(path);
            });

            $("#backup-list-panel").on("click", ".reveal-btn", function (e) {
                e.preventDefault();
                var path = $(this).data("path");
                var folder = "";
                if (path && typeof path === "string") {
                    folder = path.replace(/[^\\/]+$/, "");
                }
                if (!folder) folder = backupFolderPath;
                openBackupFolder(folder);
            });

            // ----- Flow JSON selector (panel layer) -----
            var CONFIG_FILE = "flow_config.json";
            var flowPathEl = $("#flowPath");

            var renderPresetEl = $("#renderPresetPath");
            var renderOutputEl = $("#renderOutputPath");
            var flowMatchEl = $("#flowMatchDot");
            var flowNameEl = $("#flow_file_name");
            var flowWarningEl = $("#flowMismatchWarning");
            var currentFlowName = "";
            var currentFlowPath = "";
            var pendingFlowReload = false;
            var backupFlowLabel = $("#backup-flow-path");
            var backupFolderLabel = $("#backup-folder-path");
            var backupListEl = $("#backup-list-panel");
            var backupStatusEl = $("#backup-status");
            var backupFlowPath = "";
            var backupFolderPath = "";
            var backupIntervalSelect = $("#backup-interval-select");

            function baseName(path) {
                if (!path) return "";
                var parts = path.split(/[\\/]/);
                return parts.length ? parts[parts.length - 1] : path;
            }

            function prefixKey(str) {
                if (!str) return "";
                return str.replace(/[^A-Za-z0-9]/g, "").slice(0, 4).toUpperCase();
            }

            function setFlowWarning(active, message) {
                if (!flowWarningEl || !flowWarningEl.length) return;
                if (typeof message === "string" && message) {
                    flowWarningEl.text(message);
                }
                if (active) {
                    flowWarningEl.addClass("visible");
                    flowWarningEl.attr("aria-hidden", "false");
                } else {
                    flowWarningEl.removeClass("visible");
                    flowWarningEl.attr("aria-hidden", "true");
                }
            }

            window.refreshFlowMatchState = function () {
                var dot = flowMatchEl.get(0);
                var seqEl = document.getElementById("active_seq");
                if (!dot || !seqEl || !flowNameEl.length) return;

                var seqName = (seqEl.textContent || "").trim();
                flowNameEl.text(currentFlowName || "[not set]");
                flowNameEl.attr("title", backupFlowPath || "[not set]");

                dot.classList.remove("match", "mismatch", "neutral", "blink");
                setFlowWarning(false);

                if (!currentFlowName || !seqName || seqName === "[uninitialized]") {
                    dot.classList.add("neutral");
                    dot.title = "Waiting for sequence and flow";
                    return;
                }

                var match = prefixKey(seqName) === prefixKey(currentFlowName);
                dot.classList.add(match ? "match" : "mismatch");
                dot.title = match ? "Flow matches project prefix" : "Flow does not match project prefix";
                if (match) {
                    return;
                }
                dot.classList.add("blink");
                setFlowWarning(true, "Sequence \"" + seqName + "\" and flow \"" + currentFlowName + "\" do not match.");
            };

            function requestShowflowReload(reason) {
                var frame = document.getElementById("showflowFrame");
                var sent = false;
                if (frame && frame.contentWindow) {
                    try {
                        frame.contentWindow.postMessage({
                            type: "reload-from-disk",
                            reason: reason || "flow-path-updated"
                        }, "*");
                        sent = true;
                    } catch (err) {
                        sent = false;
                    }
                }
                pendingFlowReload = !sent;
            }

            function sanitizeBackupSegment(name) {
                var safe = (name || "flow").replace(/[<>:"/\\|?*\x00-\x1F]/g, "_");
                safe = safe.replace(/\s+/g, "_");
                if (!safe) safe = "flow";
                return safe;
            }

            function backupInfoFromFlowPath(flowPath) {
                if (!flowPath) return null;
                var usesBackslash = flowPath.indexOf("\\") >= 0;
                var normalized = flowPath.replace(/\\/g, "/");
                var lastSlash = normalized.lastIndexOf("/");
                var dir = lastSlash >= 0 ? normalized.substring(0, lastSlash) : "";
                var file = lastSlash >= 0 ? normalized.substring(lastSlash + 1) : normalized;
                var base = file.replace(/\.[^.]+$/, "");
                var safeBase = sanitizeBackupSegment(base);
                var folder = dir + "/__showflow_backups/" + safeBase;
                if (usesBackslash) {
                    folder = folder.replace(/\//g, "\\");
                }
                var sep = usesBackslash ? "\\" : "/";
                return {
                    folderPath: folder,
                    separator: sep,
                    fileName: file,
                    safeBase: safeBase
                };
            }

            function joinPaths(dir, child, sepOverride) {
                if (!dir) return child;
                var sep = sepOverride || (dir.indexOf("\\") >= 0 ? "\\" : "/");
                if (dir.endsWith("\\") || dir.endsWith("/")) {
                    return dir + child;
                }
                return dir + sep + child;
            }

            function parseBackupName(name) {
                var match = name.match(/__(\d{8}-\d{6})/);
                if (!match) {
                    return {
                        label: name,
                        sortValue: name.toLowerCase(),
                        iso: ""
                    };
                }
                var stamp = match[1]; // YYYYMMDD-HHMMSS
                var date = null;
                try {
                    var year = parseInt(stamp.substring(0, 4), 10);
                    var month = parseInt(stamp.substring(4, 6), 10) - 1;
                    var day = parseInt(stamp.substring(6, 8), 10);
                    var hour = parseInt(stamp.substring(9, 11), 10);
                    var min = parseInt(stamp.substring(11, 13), 10);
                    var sec = parseInt(stamp.substring(13, 15), 10);
                    date = new Date(year, month, day, hour, min, sec);
                } catch (e) {
                    date = null;
                }
                var label = date ? date.toLocaleString() : stamp;
                var sortValue = date ? date.getTime() : stamp;
                return {
                    label: label,
                    sortValue: sortValue,
                    iso: stamp
                };
            }

            function setBackupStatus(text) {
                if (!backupStatusEl || backupStatusEl.length === 0) return;
                backupStatusEl.text(text || "");
            }

            function updateBackupIntervalUI(minutes) {
                if (!backupIntervalSelect || backupIntervalSelect.length === 0) return;
                var clamped = parseInt(minutes, 10);
                if (isNaN(clamped)) clamped = 5;
                clamped = Math.max(1, Math.min(60, clamped));
                backupIntervalSelect.val(String(clamped));
            }

            function updateBackupMeta(flowPath, overrideFolder) {
                backupFlowPath = flowPath || "";
                var info = backupInfoFromFlowPath(flowPath);
                backupFolderPath = overrideFolder || (info ? info.folderPath : "");
                if (backupFlowLabel && backupFlowLabel.length) {
                    backupFlowLabel.text(backupFlowPath || "[not set]");
                }
                if (backupFolderLabel && backupFolderLabel.length) {
                    backupFolderLabel.text(backupFolderPath || "[not created]");
                }
                if (flowNameEl && flowNameEl.length) {
                    flowNameEl.attr("title", backupFlowPath || "[not set]");
                }
            }

            function renderBackupEntries(entries) {
                if (!backupListEl || backupListEl.length === 0) return;
                if (!entries || entries.length === 0) {
                    backupListEl.html("<div class='backup-empty'>No backups found for this showflow yet.</div>");
                    return;
                }
                var html = entries.map(function (item) {
                    return "<div class='backup-row'>" +
                        "<div class='backup-info'>" +
                        "<div class='backup-name'>" + item.name + "</div>" +
                        "<div class='backup-meta-text'>" + item.label + "</div>" +
                        "</div>" +
                        "<div class='backup-actions'>" +
                        "<button class='pill-btn restore-btn' data-path=\"" + item.path.replace(/\"/g, "&quot;") + "\">Restore</button>" +
                        "<button class='pill-btn ghost reveal-btn' data-path=\"" + item.path.replace(/\"/g, "&quot;") + "\">Reveal</button>" +
                        "</div>" +
                        "</div>";
                }).join("");
                backupListEl.html(html);
            }

            function refreshBackupList() {
                var cfg = loadFlowConfig();
                var flowPath = (cfg && cfg.flowPath) ? cfg.flowPath : "";
                updateBackupMeta(flowPath);
                if (!flowPath) {
                    renderBackupEntries([]);
                    setBackupStatus("Pick a showflow file to enable backups.");
                    return;
                }
                var info = backupInfoFromFlowPath(flowPath);
                if (!info) {
                    renderBackupEntries([]);
                    setBackupStatus("Unable to determine backup folder.");
                    return;
                }
                var folderListing = window.cep.fs.readdir(info.folderPath);
                if (folderListing.err !== 0 || !folderListing.data || folderListing.data.length === 0) {
                    renderBackupEntries([]);
                    setBackupStatus("No backups saved yet.");
                    return;
                }
                var entries = folderListing.data.filter(function (name) {
                    return /\.json$/i.test(name);
                }).map(function (name) {
                    var parsed = parseBackupName(name);
                    return {
                        name: name,
                        label: parsed.label,
                        sortValue: parsed.sortValue,
                        path: joinPaths(info.folderPath, name, info.separator)
                    };
                }).sort(function (a, b) {
                    return b.sortValue - a.sortValue;
                });
                renderBackupEntries(entries);
                setBackupStatus(entries.length + " backup(s) available");
            }

            function openBackupFolder(path) {
                if (!path) {
                    alert("No backup folder available.");
                    return;
                }
                var jsx = "(function(){\n" +
                    "var folder = new Folder(decodeURIComponent('" + encodeURIComponent(path) + "'));\n" +
                    "if(!folder.exists){return 'missing';}\n" +
                    "try{folder.execute();return 'ok';}catch(e){return e.toString();}\n" +
                    "})();";
                var csInterface = new CSInterface();
                csInterface.evalScript(jsx, function (res) {
                    if (res !== "ok") {
                        alert("Unable to open folder: " + res);
                    }
                });
            }

            function requestManualBackup() {
                var frame = document.getElementById("showflowFrame");
                if (!frame || !frame.contentWindow) {
                    alert("Showflow editor is not available.");
                    return;
                }
                setBackupStatus("Requesting manual backup from editor…");
                try {
                    frame.contentWindow.postMessage({ type: "manual-backup-request" }, "*");
                } catch (e) {
                    alert("Failed to talk to editor: " + e);
                }
            }

            function restoreBackupFile(path) {
                if (!path) return;
                var cfg = loadFlowConfig();
                if (!cfg.flowPath) {
                    alert("No flow file configured.");
                    return;
                }
                if (!confirm("Restore this backup?\n\n" + path + "\n\nThis will overwrite the current flow file.")) {
                    return;
                }
                var contents = window.cep.fs.readFile(path);
                if (contents.err !== 0) {
                    alert("Could not read backup file.");
                    return;
                }
                var writeResult = window.cep.fs.writeFile(cfg.flowPath, contents.data);
                if (writeResult.err !== 0) {
                    alert("Failed to overwrite flow file.");
                    return;
                }
                setBackupStatus("Backup restored. Reloading editor…");
                var frame = document.getElementById("showflowFrame");
                if (frame && frame.contentWindow) {
                    frame.contentWindow.postMessage({ type: "reload-from-disk" }, "*");
                }
                alert("Backup restored successfully.");
            }

            function configPath() {
                var csInterface = new CSInterface();
                var osVersion = csInterface.getOSInformation();
                var isWin = osVersion && osVersion.indexOf("Windows") >= 0;
                var extRoot = csInterface.getSystemPath(SystemPath.EXTENSION);
                if (isWin) extRoot = extRoot.replace(/\//g, "\\\\");
                var sep = isWin ? "\\\\" : "/";
                return extRoot + sep + CONFIG_FILE;
            }

            function readConfigFileRaw() {
                var parsed = { flowPath: "", renderPreset: "", renderOutput: "", quickScripts: [] };
                var path = configPath();
                var res = window.cep.fs.readFile(path);
                if (res.err === 0 && res.data) {
                    try {
                        var raw = JSON.parse(res.data);
                        if (raw) parsed = raw;
                    } catch (e) { }
                }
                if (!Array.isArray(parsed.quickScripts)) {
                    parsed.quickScripts = [];
                }
                return parsed;
            }

            function mergeVrConfig(raw) {
                var merged = JSON.parse(JSON.stringify(defaultVrConfig));
                if (!raw) {
                    return merged;
                }
                merged.serverUrl = raw.serverUrl || merged.serverUrl;
                merged.mode = (raw.mode === "monitor" || raw.mode === "region") ? raw.mode : merged.mode;
                if (typeof raw.monitorIndex !== "undefined") {
                    merged.monitorIndex = parseInt(raw.monitorIndex, 10) || merged.monitorIndex;
                }
                if (typeof raw.monitor_index !== "undefined") {
                    merged.monitorIndex = parseInt(raw.monitor_index, 10) || merged.monitorIndex;
                }
                if (typeof raw.fps !== "undefined") {
                    merged.fps = parseInt(raw.fps, 10) || merged.fps;
                }
                if (typeof raw.quality !== "undefined") {
                    merged.quality = parseInt(raw.quality, 10) || merged.quality;
                }
                var regionSource = raw.region || {};
                if (typeof raw.top !== "undefined" || typeof raw.left !== "undefined") {
                    regionSource = {
                        top: raw.top,
                        left: raw.left,
                        width: raw.width,
                        height: raw.height
                    };
                }
                merged.region = merged.region || {};
                merged.region.top = parseInt(regionSource.top, 10) >= 0 ? parseInt(regionSource.top, 10) : merged.region.top;
                merged.region.left = parseInt(regionSource.left, 10) >= 0 ? parseInt(regionSource.left, 10) : merged.region.left;
                merged.region.width = parseInt(regionSource.width, 10) > 0 ? parseInt(regionSource.width, 10) : merged.region.width;
                merged.region.height = parseInt(regionSource.height, 10) > 0 ? parseInt(regionSource.height, 10) : merged.region.height;
                merged.aspectLock = !!raw.aspectLock;
                return merged;
            }

            function updateVrInputs() {
                if (!vrEls.serverUrl) {
                    return;
                }
                vrEls.serverUrl.val(currentVrConfig.serverUrl || "");
                vrEls.modeSelect.val(currentVrConfig.mode || "region");
                vrEls.fpsInput.val(currentVrConfig.fps || 30);
                vrEls.qualityInput.val(currentVrConfig.quality || 80);
                vrEls.topInput.val(currentVrConfig.region.top || 0);
                vrEls.leftInput.val(currentVrConfig.region.left || 0);
                vrEls.widthInput.val(currentVrConfig.region.width || 1280);
                vrEls.heightInput.val(currentVrConfig.region.height || 720);
                if (vrEls.monitorSelect && vrEls.monitorSelect.length) {
                    vrEls.monitorSelect.val(String(currentVrConfig.monitorIndex));
                }
                if (vrEls.aspectLock && vrEls.aspectLock.length) {
                    vrEls.aspectLock.prop("checked", !!currentVrConfig.aspectLock);
                }
                var displayUrl = sanitizeVrUrl(currentVrConfig.serverUrl) || "http://localhost:5000";
                if (vrEls.instructionIp && vrEls.instructionIp.length) {
                    vrEls.instructionIp.text(displayUrl);
                }
                updateCropOverlayFromConfig();
            }

            function updateMonitorOptions(monitors) {
                vrMonitors = monitors || [];
                if (!vrEls.monitorSelect || vrEls.monitorSelect.length === 0) {
                    return;
                }
                vrEls.monitorSelect.empty();
                if (!vrMonitors.length) {
                    vrEls.monitorSelect.append("<option value=\"0\">Virtual desktop</option>");
                    if (currentVrConfig.monitorIndex > 0) {
                        vrEls.monitorSelect.append("<option value=\"" + currentVrConfig.monitorIndex + "\">Monitor " + currentVrConfig.monitorIndex + "</option>");
                    }
                } else {
                    vrMonitors.forEach(function (mon) {
                        var label = "Monitor " + mon.index + " (" + mon.width + "x" + mon.height + ")";
                        if (mon.index === 0) {
                            label = "All displays (" + mon.width + "x" + mon.height + ")";
                        }
                        vrEls.monitorSelect.append("<option value=\"" + mon.index + "\">" + label + "</option>");
                    });
                }
                vrEls.monitorSelect.val(String(currentVrConfig.monitorIndex));
                updateCropOverlayFromConfig();
            }

            function clamp(value, minimum, maximum) {
                return Math.min(Math.max(value, minimum), maximum);
            }

            function getActiveMonitorInfo() {
                if (!vrMonitors || !vrMonitors.length) {
                    return null;
                }
                var targetIndex = parseInt(currentVrConfig.monitorIndex, 10);
                var selected = vrMonitors.find(function (mon) {
                    return parseInt(mon.index, 10) === targetIndex;
                });
                return selected || vrMonitors[0];
            }

            function getPreviewAspectRatio() {
                var fallback = 16 / 9;
                var width = 0;
                var height = 0;
                if (currentVrConfig.mode === "monitor") {
                    var monitorInfo = getActiveMonitorInfo();
                    if (monitorInfo) {
                        width = parseInt(monitorInfo.width, 10);
                        height = parseInt(monitorInfo.height, 10);
                    }
                } else {
                    width = parseInt(currentVrConfig.region.width, 10);
                    height = parseInt(currentVrConfig.region.height, 10);
                    if (!(width > 0 && height > 0)) {
                        var regionFallback = getActiveMonitorInfo();
                        if (regionFallback) {
                            width = parseInt(regionFallback.width, 10);
                            height = parseInt(regionFallback.height, 10);
                        }
                    }
                }
                if (!(width > 0 && height > 0)) {
                    return fallback;
                }
                var ratio = width / height;
                if (!isFinite(ratio) || ratio <= 0) {
                    return fallback;
                }
                return clamp(ratio, 0.25, 4);
            }

            function updatePreviewAspectRatio() {
                var ratio = getPreviewAspectRatio();
                document.querySelectorAll(".vr-preview-display").forEach(function (el) {
                    el.style.setProperty("--vr-preview-aspect", ratio);
                });
            }

            function normalizedRectFromConfig() {
                var mon = getActiveMonitorInfo();
                if (!mon || !mon.width || !mon.height) {
                    return null;
                }
                var left = clamp(currentVrConfig.region.left || 0, 0, Math.max(0, mon.width));
                var top = clamp(currentVrConfig.region.top || 0, 0, Math.max(0, mon.height));
                var width = Math.max(1, currentVrConfig.region.width || mon.width);
                var height = Math.max(1, currentVrConfig.region.height || mon.height);
                if (left + width > mon.width) {
                    width = mon.width - left;
                }
                if (top + height > mon.height) {
                    height = mon.height - top;
                }
                return {
                    x: left / mon.width,
                    y: top / mon.height,
                    width: Math.max(width / mon.width, 0.01),
                    height: Math.max(height / mon.height, 0.01)
                };
            }

            function clampRect(rect) {
                var min = 0.01;
                rect.width = Math.max(rect.width, min);
                rect.height = Math.max(rect.height, min);
                rect.x = clamp(rect.x, 0, 1 - rect.width);
                rect.y = clamp(rect.y, 0, 1 - rect.height);
                return rect;
            }

            function enforceAspectRatioRect(rect) {
                var ratio = 2;
                var startRect = cropDragState.startRect || rect;
                var widthChange = Math.abs(rect.width - startRect.width);
                var heightChange = Math.abs(rect.height - startRect.height);
                var useWidth = widthChange >= heightChange;
                var centerX = rect.x + rect.width / 2;
                var centerY = rect.y + rect.height / 2;
                if (useWidth) {
                    rect.height = rect.width / ratio;
                } else {
                    rect.width = rect.height * ratio;
                }
                rect = clampRect(rect);
                rect.x = centerX - rect.width / 2;
                rect.y = centerY - rect.height / 2;
                rect = clampRect(rect);
                return rect;
            }

            function updateCropOverlayFromConfig() {
                if (!vrCropOverlayEl || !vrCropSelectionEl) {
                    updatePreviewAspectRatio();
                    return;
                }
                if (currentVrConfig.mode !== "region") {
                    vrCropOverlayEl.classList.add("disabled");
                    vrCropSelectionEl.classList.add("hidden");
                    updatePreviewAspectRatio();
                    return;
                }
                var normalized = normalizedRectFromConfig();
                if (!normalized) {
                    vrCropOverlayEl.classList.add("disabled");
                    vrCropSelectionEl.classList.add("hidden");
                    updatePreviewAspectRatio();
                    return;
                }
                cropOverlayRect = clampRect(normalized);
                vrCropOverlayEl.classList.remove("disabled");
                renderCropSelection();
                updatePreviewAspectRatio();
            }

            function renderCropSelection() {
                if (!vrCropOverlayEl || !vrCropSelectionEl) return;
                if (vrCropOverlayEl.classList.contains("disabled")) {
                    vrCropSelectionEl.classList.add("hidden");
                    return;
                }
                var width = vrCropOverlayEl.clientWidth;
                var height = vrCropOverlayEl.clientHeight;
                if (!width || !height) {
                    vrCropSelectionEl.classList.add("hidden");
                    return;
                }
                vrCropSelectionEl.classList.remove("hidden");
                vrCropSelectionEl.style.left = (cropOverlayRect.x * 100) + "%";
                vrCropSelectionEl.style.top = (cropOverlayRect.y * 100) + "%";
                vrCropSelectionEl.style.width = (cropOverlayRect.width * 100) + "%";
                vrCropSelectionEl.style.height = (cropOverlayRect.height * 100) + "%";
            }

            function applyCropDragDelta(startRect, mode, dx, dy) {
                var rect = Object.assign({}, startRect);
                var min = 0.01;
                if (mode === "move") {
                    rect.x = clamp(rect.x + dx, 0, 1 - rect.width);
                    rect.y = clamp(rect.y + dy, 0, 1 - rect.height);
                } else {
                    if (mode.indexOf("n") >= 0) {
                        var newTop = clamp(startRect.y + dy, 0, startRect.y + startRect.height - min);
                        rect.height = startRect.height + (startRect.y - newTop);
                        rect.y = newTop;
                    }
                    if (mode.indexOf("s") >= 0) {
                        rect.height = clamp(startRect.height + dy, min, 1 - rect.y);
                    }
                    if (mode.indexOf("w") >= 0) {
                        var newLeft = clamp(startRect.x + dx, 0, startRect.x + startRect.width - min);
                        rect.width = startRect.width + (startRect.x - newLeft);
                        rect.x = newLeft;
                    }
                    if (mode.indexOf("e") >= 0) {
                        rect.width = clamp(startRect.width + dx, min, 1 - rect.x);
                    }
                }
                if (currentVrConfig.aspectLock && mode !== "move") {
                    rect = enforceAspectRatioRect(rect);
                }
                return clampRect(rect);
            }

            function applyOverlayRectToConfig(commit, syncInputs) {
                if (currentVrConfig.mode !== "region") {
                    return;
                }
                var mon = getActiveMonitorInfo();
                if (!mon || !mon.width || !mon.height) {
                    return;
                }
                var region = {
                    left: Math.round(cropOverlayRect.x * mon.width),
                    top: Math.round(cropOverlayRect.y * mon.height),
                    width: Math.round(cropOverlayRect.width * mon.width),
                    height: Math.round(cropOverlayRect.height * mon.height)
                };
                region.left = clamp(region.left, 0, Math.max(0, mon.width - 1));
                region.top = clamp(region.top, 0, Math.max(0, mon.height - 1));
                if (region.left + region.width > mon.width) {
                    region.width = mon.width - region.left;
                }
                if (region.top + region.height > mon.height) {
                    region.height = mon.height - region.top;
                }
                region.width = Math.max(region.width, 1);
                region.height = Math.max(region.height, 1);
                if (currentVrConfig.aspectLock) {
                    region.height = Math.round(region.width / 2);
                    if (region.top + region.height > mon.height) {
                        region.height = mon.height - region.top;
                        region.width = Math.round(region.height * 2);
                        if (region.left + region.width > mon.width) {
                            region.width = mon.width - region.left;
                            region.height = Math.round(region.width / 2);
                        }
                    }
                }
                currentVrConfig.region.top = region.top;
                currentVrConfig.region.left = region.left;
                currentVrConfig.region.width = region.width;
                currentVrConfig.region.height = region.height;
                if (syncInputs) {
                    updateRegionInputsFromCurrent();
                }
                if (commit) {
                    if (sanitizeVrUrl(currentVrConfig.serverUrl)) {
                        sendVrConfigToServer();
                    }
                }
            }

            function updateRegionInputsFromCurrent() {
                if (!vrEls.topInput) {
                    return;
                }
                vrEls.topInput.val(currentVrConfig.region.top);
                vrEls.leftInput.val(currentVrConfig.region.left);
                vrEls.widthInput.val(currentVrConfig.region.width);
                vrEls.heightInput.val(currentVrConfig.region.height);
            }

            function updateRegionFromInputs() {
                if (!vrEls.topInput) return;
                currentVrConfig.region.top = readNumberValue(vrEls.topInput, currentVrConfig.region.top, 0);
                currentVrConfig.region.left = readNumberValue(vrEls.leftInput, currentVrConfig.region.left, 0);
                currentVrConfig.region.width = readNumberValue(vrEls.widthInput, currentVrConfig.region.width, 1);
                currentVrConfig.region.height = readNumberValue(vrEls.heightInput, currentVrConfig.region.height, 1);
                updateCropOverlayFromConfig();
            }

            function startCropDrag(mode, evt) {
                if (!vrCropOverlayEl || !vrCropSelectionEl) return;
                if (vrCropOverlayEl.classList.contains("disabled") || currentVrConfig.mode !== "region") {
                    return;
                }
                if (evt.button !== 0) return;
                evt.preventDefault();
                cropDragState = {
                    active: true,
                    mode: mode,
                    startX: evt.clientX,
                    startY: evt.clientY,
                    containerRect: vrCropOverlayEl.getBoundingClientRect(),
                    startRect: Object.assign({}, cropOverlayRect)
                };
                document.addEventListener("pointermove", handleCropPointerMove);
                document.addEventListener("pointerup", handleCropPointerUp);
            }

            function handleCropPointerMove(evt) {
                if (!cropDragState.active) return;
                evt.preventDefault();
                var dx = 0;
                var dy = 0;
                if (cropDragState.containerRect.width > 0) {
                    dx = (evt.clientX - cropDragState.startX) / cropDragState.containerRect.width;
                }
                if (cropDragState.containerRect.height > 0) {
                    dy = (evt.clientY - cropDragState.startY) / cropDragState.containerRect.height;
                }
                var next = applyCropDragDelta(cropDragState.startRect, cropDragState.mode, dx, dy);
                cropOverlayRect = next;
                renderCropSelection();
                applyOverlayRectToConfig(false, true);
            }

            function handleCropPointerUp() {
                if (!cropDragState.active) return;
                document.removeEventListener("pointermove", handleCropPointerMove);
                document.removeEventListener("pointerup", handleCropPointerUp);
                cropDragState.active = false;
                applyOverlayRectToConfig(true, true);
            }

            function attachCropOverlayEvents() {
                if (!vrCropSelectionEl) return;
                vrCropSelectionEl.addEventListener("pointerdown", function (evt) {
                    if (evt.target && evt.target.classList.contains("vr-crop-handle")) {
                        return;
                    }
                    startCropDrag("move", evt);
                });
                var handles = vrCropSelectionEl.querySelectorAll(".vr-crop-handle");
                handles.forEach(function (handle) {
                    handle.addEventListener("pointerdown", function (evt) {
                        startCropDrag(handle.getAttribute("data-handle") || "se", evt);
                        evt.stopPropagation();
                    });
                });
            }

            function sanitizeVrUrl(url) {
                if (!url) return "";
                var trimmed = String(url).trim();
                if (!trimmed) return "";
                if (!/^https?:\/\//i.test(trimmed)) {
                    trimmed = "http://" + trimmed;
                }
                return trimmed.replace(/\/+$/, "");
            }

            function buildVrEndpoint(path) {
                var base = sanitizeVrUrl(currentVrConfig.serverUrl);
                if (!base) return "";
                if (!path) return base;
                if (path.charAt(0) !== "/") {
                    path = "/" + path;
                }
                return base + path;
            }

            function setVrStatus(text, isOnline) {
                if (vrEls.statusText && vrEls.statusText.length) {
                    vrEls.statusText.text(text || "");
                }
                if (!vrEls.statusChip || vrEls.statusChip.length === 0) {
                    return;
                }
                vrEls.statusChip.removeClass("online offline");
                vrEls.statusChip.addClass(isOnline ? "online" : "offline");
                if (vrEls.statusLabel && vrEls.statusLabel.length) {
                    vrEls.statusLabel.text(isOnline ? "Online" : "Offline");
                }
                if (isOnline) {
                    if (vrEls.previewOverlay && vrEls.previewOverlay.length) {
                        vrEls.previewOverlay.hide();
                    }
                    if (vrEls.frameOverlay && vrEls.frameOverlay.length) {
                        vrEls.frameOverlay.hide();
                    }
                } else {
                    if (vrEls.previewOverlay && vrEls.previewOverlay.length) {
                        vrEls.previewOverlay.text(text || "Server offline").show();
                    }
                    if (vrEls.frameOverlay && vrEls.frameOverlay.length) {
                        var overlayText = currentVrConfig.serverUrl ? "Server offline" : "Server URL not set";
                        vrEls.frameOverlay.text(overlayText).show();
                    }
                }
            }

            function refreshVrPreview() {
                if (!vrEls.previewImage || vrEls.previewImage.length === 0) {
                    return;
                }
                var endpoint = buildVrEndpoint("/video_feed");
                if (!endpoint) {
                    vrEls.previewImage.removeAttr("src");
                    if (vrEls.previewOverlay && vrEls.previewOverlay.length) {
                        vrEls.previewOverlay.text("Set a server URL to preview").show();
                    }
                    return;
                }
                vrEls.previewImage.attr("src", endpoint + "?ts=" + Date.now());
            }

            function updateVrFrameSource() {
                if (!vrEls.frame || vrEls.frame.length === 0) {
                    return;
                }
                var base = sanitizeVrUrl(currentVrConfig.serverUrl);
                if (!base) {
                    vrEls.frame.attr("src", "about:blank");
                    if (vrEls.frameOverlay && vrEls.frameOverlay.length) {
                        vrEls.frameOverlay.text("Server URL not set").show();
                    }
                    return;
                }
                vrEls.frame.attr("src", base + "/?ts=" + Date.now());
                if (vrEls.frameOverlay && vrEls.frameOverlay.length) {
                    vrEls.frameOverlay.hide();
                }
            }

            function persistVrConfig() {
                var cfg = readConfigFileRaw();
                cfg.vr = currentVrConfig;
                saveFlowConfig(cfg);
            }

            function pingVrServer(showStatusText) {
                var endpoint = buildVrEndpoint("/health");
                if (!endpoint) {
                    setVrStatus("Set a server URL to begin.", false);
                    return Promise.resolve();
                }
                if (showStatusText) {
                    setVrStatus("Checking server...", false);
                }
                return fetch(endpoint + "?ts=" + Date.now(), { cache: "no-store" })
                    .then(function (res) {
                        if (!res.ok) {
                            throw new Error("HTTP " + res.status);
                        }
                        return res.json();
                    })
                    .then(function (payload) {
                        setVrStatus("Server reachable", true);
                        if (payload && payload.ip && vrEls.localIp && vrEls.localIp.length) {
                            vrEls.localIp.text(payload.ip);
                            if (vrEls.instructionIp && vrEls.instructionIp.length) {
                                vrEls.instructionIp.text("http://" + payload.ip + ":5000");
                            }
                        }
                        if (payload && payload.monitors) {
                            updateMonitorOptions(payload.monitors);
                        }
                        if (payload && payload.config) {
                            var merged = mergeVrConfig(payload.config);
                            merged.serverUrl = currentVrConfig.serverUrl;
                            currentVrConfig = merged;
                            updateVrInputs();
                        }
                        refreshVrPreview();
                        updateVrFrameSource();
                    })
                    .catch(function (err) {
                        setVrStatus("Server unreachable (" + err.message + ")", false);
                        if (vrEls.localIp && vrEls.localIp.length) {
                            vrEls.localIp.text("-");
                        }
                    });
            }

            function sendVrConfigToServer() {
                var endpoint = buildVrEndpoint("/update_config");
                if (!endpoint) {
                    alert("Set the VR server URL first.");
                    return;
                }
                if (vrEls.configStatus) {
                    vrEls.configStatus.text("Sending settings to server...");
                }
                var payload = {
                    monitor_index: currentVrConfig.monitorIndex,
                    mode: currentVrConfig.mode,
                    fps: currentVrConfig.fps,
                    quality: currentVrConfig.quality,
                    region: {
                        top: currentVrConfig.region.top,
                        left: currentVrConfig.region.left,
                        width: currentVrConfig.region.width,
                        height: currentVrConfig.region.height
                    }
                };
                fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                }).then(function (res) {
                    if (!res.ok) {
                        throw new Error("HTTP " + res.status);
                    }
                    return res.json();
                }).then(function () {
                    if (vrEls.configStatus) {
                        vrEls.configStatus.text("Applied at " + new Date().toLocaleTimeString());
                    }
                    refreshVrPreview();
                    return pingVrServer();
                }).catch(function (err) {
                    if (vrEls.configStatus) {
                        vrEls.configStatus.text("Failed to send settings: " + err.message);
                    }
                });
            }

            function readNumberValue(element, fallback, min) {
                var val = parseInt(element.val(), 10);
                if (isNaN(val)) {
                    val = fallback;
                }
                if (typeof min === "number") {
                    val = Math.max(min, val);
                }
                return val;
            }
            function loadFlowConfig() {
                var parsed = readConfigFileRaw();
                var newFlowPath = parsed.flowPath || "";
                flowPathEl.text(newFlowPath || "[not set]");

                renderPresetEl.text(parsed.renderPreset || "[not set]");
                renderOutputEl.text(parsed.renderOutput || "[not set]");
                updateBackupMeta(newFlowPath || "");
                if (newFlowPath !== currentFlowPath) {
                    currentFlowPath = newFlowPath;
                    requestShowflowReload("flow-path-updated");
                }
                currentFlowName = baseName(newFlowPath || "") || "";
                window.refreshFlowMatchState();
                refreshQuickRunUI(parsed.quickScripts || []);
                currentVrConfig = mergeVrConfig(parsed.vr);
                updateVrInputs();
                updateVrFrameSource();
                refreshVrPreview();
                return parsed;
            }

            function saveFlowConfig(cfg) {
                var path = configPath();
                var payload = JSON.stringify(cfg || {}, null, 2);
                window.cep.fs.writeFile(path, payload);
                loadFlowConfig(); // refresh display
            }

            function launchFlowFilePickerDialog() {
                var csInterface = new CSInterface();
                var startFolder = csInterface.getSystemPath(SystemPath.EXTENSION);
                var dlg = window.cep.fs.showOpenDialog(false, false, "Select showflow JSON", startFolder, ["json"]);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    var selectedPath = dlg.data[0];
                    if (!selectedPath) {
                        return;
                    }
                    var existingPath = current.flowPath || "";
                    if (selectedPath && existingPath && selectedPath === existingPath) {
                        return;
                    }
                    current.flowPath = selectedPath;
                    saveFlowConfig(current);
                }
            }

            function openFlowFilePicker() {
                var modal = document.getElementById("flow-pick-modal");
                if (modal) {
                    modal.style.display = "flex";
                } else {
                    launchFlowFilePickerDialog();
                }
            }

            function closeFlowPickModal(confirmed) {
                var modal = document.getElementById("flow-pick-modal");
                if (modal) {
                    modal.style.display = "none";
                }
                if (confirmed) {
                    launchFlowFilePickerDialog();
                }
            }

            function handlePickFlowClick(e) {
                if (e) e.preventDefault();
                openFlowFilePicker();
            }

            $("#pickFlow").on("click", handlePickFlowClick);
            $("#pickFlowStatusBtn").on("click", handlePickFlowClick);
            $("#flowPickCancel").on("click", function () { closeFlowPickModal(false); });
            $("#flowPickConfirm").on("click", function () { closeFlowPickModal(true); });

            $("#clearFlow").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.flowPath = "";
                saveFlowConfig(current);
            });



            $("#pickRenderPreset").on("click", function (e) {
                e.preventDefault();
                var dlg = window.cep.fs.showOpenDialog(false, false, "Select AME preset (.epr)", "", ["epr"]);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    current.renderPreset = dlg.data[0];
                    saveFlowConfig(current);
                }
            });

            $("#clearRenderPreset").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.renderPreset = "";
                saveFlowConfig(current);
            });

            $("#pickRenderOutput").on("click", function (e) {
                e.preventDefault();
                var dlg = window.cep.fs.showOpenDialog(false, true, "Select render output folder", "", []);
                if (dlg.err === 0 && dlg.data && dlg.data.length > 0) {
                    var current = loadFlowConfig() || {};
                    current.renderOutput = dlg.data[0];
                    saveFlowConfig(current);
                }
            });

            $("#clearRenderOutput").on("click", function (e) {
                e.preventDefault();
                var current = loadFlowConfig() || {};
                current.renderOutput = "";
                saveFlowConfig(current);
            });

            $("#btn-vr-save-host").on("click", function (e) {
                e.preventDefault();
                currentVrConfig.serverUrl = sanitizeVrUrl(vrEls.serverUrl.val());
                currentVrConfig.mode = (vrEls.modeSelect.val() === "monitor") ? "monitor" : "region";
                currentVrConfig.fps = readNumberValue(vrEls.fpsInput, defaultVrConfig.fps, 1);
                currentVrConfig.quality = readNumberValue(vrEls.qualityInput, defaultVrConfig.quality, 10);
                currentVrConfig.monitorIndex = readNumberValue(vrEls.monitorSelect, currentVrConfig.monitorIndex, 0);
                currentVrConfig.aspectLock = vrEls.aspectLock ? vrEls.aspectLock.is(":checked") : currentVrConfig.aspectLock;
                persistVrConfig();
                updateVrInputs();
                updateVrFrameSource();
                pingVrServer(true);
            });

            $("#btn-vr-apply").on("click", function (e) {
                e.preventDefault();
                currentVrConfig.region.top = readNumberValue(vrEls.topInput, currentVrConfig.region.top, 0);
                currentVrConfig.region.left = readNumberValue(vrEls.leftInput, currentVrConfig.region.left, 0);
                currentVrConfig.region.width = readNumberValue(vrEls.widthInput, currentVrConfig.region.width, 1);
                currentVrConfig.region.height = readNumberValue(vrEls.heightInput, currentVrConfig.region.height, 1);
                currentVrConfig.monitorIndex = readNumberValue(vrEls.monitorSelect, currentVrConfig.monitorIndex, 0);
                currentVrConfig.aspectLock = vrEls.aspectLock ? vrEls.aspectLock.is(":checked") : currentVrConfig.aspectLock;
                updateCropOverlayFromConfig();
                persistVrConfig();
                sendVrConfigToServer();
            });

            $("#btn-vr-check").on("click", function (e) {
                e.preventDefault();
                pingVrServer(true);
            });

            $("#btn-vr-refresh-preview").on("click", function (e) {
                e.preventDefault();
                refreshVrPreview();
            });

            if (vrEls.modeSelect && vrEls.modeSelect.length) {
                vrEls.modeSelect.on("change", function () {
                    currentVrConfig.mode = (vrEls.modeSelect.val() === "monitor") ? "monitor" : "region";
                    updateCropOverlayFromConfig();
                });
            }
            if (vrEls.monitorSelect && vrEls.monitorSelect.length) {
                vrEls.monitorSelect.on("change", function () {
                    currentVrConfig.monitorIndex = readNumberValue(vrEls.monitorSelect, currentVrConfig.monitorIndex, 0);
                    updateCropOverlayFromConfig();
                });
            }
            if (vrEls.aspectLock && vrEls.aspectLock.length) {
                vrEls.aspectLock.on("change", function () {
                    currentVrConfig.aspectLock = $(this).is(":checked");
                    updateCropOverlayFromConfig();
                });
            }
            [vrEls.topInput, vrEls.leftInput, vrEls.widthInput, vrEls.heightInput].forEach(function (inputEl) {
                if (inputEl && inputEl.length) {
                    inputEl.on("change", updateRegionFromInputs);
                }
            });

            $("#btn-vr-seq-dims").on("click", function (e) {
                e.preventDefault();
                var csInterface = new CSInterface();
                csInterface.evalScript("$._PPP_.getActiveSequenceFrameSize()", function (res) {
                    if (!res || res.indexOf("|") === -1) {
                        alert("Unable to read sequence dimensions.");
                        return;
                    }
                    var parts = res.split("|");
                    var width = parseInt(parts[0], 10);
                    var height = parseInt(parts[1], 10);
                    if (width > 0 && height > 0) {
                        vrEls.widthInput.val(width);
                        vrEls.heightInput.val(height);
                    }
                });
            });

            $("#btn-open-browser").on("click", function (e) {
                e.preventDefault();
                var url = sanitizeVrUrl(currentVrConfig.serverUrl);
                if (!url) {
                    alert("Set the server URL first.");
                    return;
                }
                window.cep.util.openURLInDefaultBrowser(url);
            });

            $("#btn-start-server").on("click", function (e) {
                e.preventDefault();
                ServerManager.startServer();
            });

            $("#btn-open-server-folder").on("click", function (e) {
                e.preventDefault();
                ServerManager.openServerFolder();
            });

            // init flow display
            loadFlowConfig();

            updateMonitorOptions([]);
            setVrStatus("Waiting for server...", false);
            pingVrServer();
            if (vrStatusTimer) {
                clearInterval(vrStatusTimer);
            }
            vrStatusTimer = setInterval(function () {
                pingVrServer();
            }, 15000);

            $("#openViz").on("click", function (e) {
                e.preventDefault();
                activateTab("showflow");
            });

            $("#refreshShowflow").on("click", function (e) {
                e.preventDefault();
                var bust = Date.now();
                window.location.href = "refresh.html?ts=" + bust;
            });

            var showflowFrame = document.getElementById("showflowFrame");
            if (showflowFrame) {
                showflowFrame.addEventListener("load", function () {
                    try {
                        showflowFrame.contentWindow.postMessage({ type: "request-flow-context" }, "*");
                        showflowFrame.contentWindow.postMessage({ type: "request-backup-interval" }, "*");
                        if (pendingFlowReload) {
                            requestShowflowReload("frame-ready");
                        }
                    } catch (e) { }
                });
            }

            // Start on Showflow tab by default
            activateTab("showflow");
            // Sync active sequence when panel regains focus (helps when user switches sequences in PPro)
            window.addEventListener("focus", refreshSequenceInfo);

            window.addEventListener("message", function (event) {
                var data = event.data || {};
                if (data.type === "backup-created") {
                    var timeMsg = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : "just now";
                    setBackupStatus((data.mode === "manual" ? "Manual" : "Auto") + " backup saved at " + timeMsg);
                    refreshBackupList();
                } else if (data.type === "flow-context") {
                    var reportedPath = data.path || "";
                    if (reportedPath) {
                        currentFlowPath = reportedPath;
                        currentFlowName = baseName(reportedPath) || "";
                    } else {
                        currentFlowPath = "";
                        currentFlowName = "";
                    }
                    flowPathEl.text(reportedPath || "[not set]");
                    updateBackupMeta(reportedPath, data.backupFolder || "");
                    window.refreshFlowMatchState();
                    if ($("#tab-backups").hasClass("active")) {
                        refreshBackupList();
                    }
                } else if (data.type === "backup-interval-updated") {
                    updateBackupIntervalUI(data.minutes);
                }
            });

            attachCropOverlayEvents();
            if (vrEls.previewImage && vrEls.previewImage.length) {
                vrEls.previewImage.on("load", renderCropSelection);
            }
            window.addEventListener("resize", renderCropSelection);
        });
    </script>
</head>

<body onLoad="onLoaded()" class="theme-showflow">
    <div id="header">
        <div class="status-bar">
            <span class="status-chip" id="active-sequence-chip">
                <span id="active_seq">[uninitialized]</span>
            </span>
            <div class="status-refresh">
                <button class="pill-btn icon-btn" id="refreshSeq" title="Refresh active sequence"
                    aria-label="Refresh active sequence">&#x21bb;</button>
            </div>
            <span class="status-chip" id="flow-chip">
                <span id="flow_file_name">[not set]</span>
                <span class="status-dot neutral" id="flowMatchDot" title="Waiting for sequence and flow"></span>
            </span>
            <button class="pill-btn icon-btn tiny" id="pickFlowStatusBtn" title="Pick flow JSON" type="button"
                aria-label="Pick flow JSON">
                <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
                    <path fill="currentColor"
                        d="M3 6c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2h-8.6L10 5H3zm0 2h5.4l1.4 1.5H21v7.5H3z" />
                </svg>
            </button>
            <span class="status-warning" id="flowMismatchWarning" role="alert" aria-hidden="true">Sequence and flow do not
                match.</span>
        </div>
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="showflow">SHOWFLOW</button>
            <button class="tab-btn" data-tab="backups">Backups</button>
            <button class="tab-btn" data-tab="settings">Settings</button>
            <button class="tab-btn" data-tab="scripts">Scripts</button>
            <button class="tab-btn" data-tab="vr">VR</button>
            <button class="tab-btn pill-btn icon-btn" id="refreshShowflow" title="Refresh Panel"
                aria-label="Refresh Panel">&#x267b;</button>
        </div>
    </div>

    <div id="content">
        <div class="tab-panel active" id="tab-showflow">
            <div class="panel-card">
                <iframe id="showflowFrame" src="showflow_viz.html" title="Showflow Visual Editor"></iframe>
            </div>
        </div>

        <div class="tab-panel" id="tab-backups">
            <div class="panel-card backup-card">
                <h2>Backup Center</h2>
                <p class="muted">Automatic backups run quietly; visit this page when you want to inspect or restore
                    history.</p>
                <div class="backup-meta">
                    <div>Active flow: <span id="backup-flow-path">[not set]</span></div>
                    <div>Backup folder: <span id="backup-folder-path">[not created]</span></div>
                </div>
                <div class="backup-controls">
                    <button class="pill-btn" id="backup-refresh">Refresh List</button>
                    <button class="pill-btn" id="backup-open-folder">Open Folder</button>
                    <button class="pill-btn primary" id="backup-manual">Manual Backup (ask editor)</button>
                </div>
                <div class="backup-settings">
                    <label for="backup-interval-select">Auto backup every</label>
                    <select id="backup-interval-select">
                        <option value="1">1 min</option>
                        <option value="5" selected>5 min</option>
                        <option value="10">10 min</option>
                        <option value="30">30 min</option>
                    </select>
                    <span class="muted">Runs while Showflow editor is open.</span>
                </div>
                <div class="backup-status" id="backup-status">Waiting for editor…</div>
                <div class="backup-list" id="backup-list-panel"></div>
            </div>
        </div>

        <div class="tab-panel" id="tab-scripts">
            <div class="panel-grid">
                <div class="panel-card">
                    <div class="card-head">
                        <div>
                            <h2>스크립트 퀵 런</h2>
                            <p class="muted">자주 쓰는 프리미어 작업을 한 번에 실행합니다.</p>
                        </div>
                        <button class="pill-btn primary" id="openViz">Showflow 보기</button>
                    </div>
                    <div class="quick-grid">
                        <div class="quick-slot">
                            <button class="controlBg textStyle quick-run-btn" id="quickRun0" data-slot="0">
                                <span class="quick-label" id="quickLabel0">Slot 1</span>
                                <span class="quick-path" id="quickPath0">스크립트를 설정하세요.</span>
                            </button>
                            <button class="pill-btn quick-load-btn" id="quickLoad0" data-slot="0"
                                title="불러오기 (Shift+클릭: 비우기)">불러오기</button>
                        </div>
                        <div class="quick-slot">
                            <button class="controlBg textStyle quick-run-btn" id="quickRun1" data-slot="1">
                                <span class="quick-label" id="quickLabel1">Slot 2</span>
                                <span class="quick-path" id="quickPath1">스크립트를 설정하세요.</span>
                            </button>
                            <button class="pill-btn quick-load-btn" id="quickLoad1" data-slot="1"
                                title="불러오기 (Shift+클릭: 비우기)">불러오기</button>
                        </div>
                        <div class="quick-slot">
                            <button class="controlBg textStyle quick-run-btn" id="quickRun2" data-slot="2">
                                <span class="quick-label" id="quickLabel2">Slot 3</span>
                                <span class="quick-path" id="quickPath2">스크립트를 설정하세요.</span>
                            </button>
                            <button class="pill-btn quick-load-btn" id="quickLoad2" data-slot="2"
                                title="불러오기 (Shift+클릭: 비우기)">불러오기</button>
                        </div>
                        <div class="quick-slot">
                            <button class="controlBg textStyle quick-run-btn" id="quickRun3" data-slot="3">
                                <span class="quick-label" id="quickLabel3">Slot 4</span>
                                <span class="quick-path" id="quickPath3">스크립트를 설정하세요.</span>
                            </button>
                            <button class="pill-btn quick-load-btn" id="quickLoad3" data-slot="3"
                                title="불러오기 (Shift+클릭: 비우기)">불러오기</button>
                        </div>
                        <div class="quick-slot">
                            <button class="controlBg textStyle quick-run-btn" id="quickRun4" data-slot="4">
                                <span class="quick-label" id="quickLabel4">Slot 5</span>
                                <span class="quick-path" id="quickPath4">스크립트를 설정하세요.</span>
                            </button>
                            <button class="pill-btn quick-load-btn" id="quickLoad4" data-slot="4"
                                title="불러오기 (Shift+클릭: 비우기)">불러오기</button>
                        </div>
                        <div class="quick-slot">
                            <button class="controlBg textStyle quick-run-btn" id="quickRun5" data-slot="5">
                                <span class="quick-label" id="quickLabel5">Slot 6</span>
                                <span class="quick-path" id="quickPath5">스크립트를 설정하세요.</span>
                            </button>
                            <button class="pill-btn quick-load-btn" id="quickLoad5" data-slot="5"
                                title="불러오기 (Shift+클릭: 비우기)">불러오기</button>
                        </div>
                    </div>
                </div>

                <div class="panel-card render-queue">
                    <h2>Render queue</h2>
                    <div class="queue-actions">
                        <button class="queue-btn" id="run_RenderSelected">Render active sequence</button>
                        <button class="queue-btn alt" id="run_QueueMarkersToAME">Queue Markers to AME</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-panel" id="tab-settings">
            <div class="panel-grid">
                <div class="panel-card">
                    <h2>Flow file</h2>
                    <div class="path-row">
                        <span class="path-chip" id="flowPath">[not set]</span>
                    </div>
                    <div class="button-grid">
                        <div class="button-pair">
                            <button class="controlBg textStyle" id="pickFlow">Pick flow JSON</button>
                            <button class="controlBg textStyle" id="clearFlow">Clear</button>
                        </div>
                    </div>
                </div>

                <div class="panel-card">
                    <h2>Render</h2>
                    <div class="path-row">
                        <span class="path-chip">Preset: <span id="renderPresetPath">[not set]</span></span>
                    </div>
                    <div class="button-grid">
                        <div class="button-pair">
                            <button class="controlBg textStyle" id="pickRenderPreset">Pick preset (.epr)</button>
                            <button class="controlBg textStyle" id="clearRenderPreset">Clear preset</button>
                        </div>
                    </div>
                    <div class="path-row">
                        <span class="path-chip">Output: <span id="renderOutputPath">[not set]</span></span>
                    </div>
                    <div class="button-grid">
                        <div class="button-pair">
                            <button class="controlBg textStyle" id="pickRenderOutput">Pick output folder</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="dragthing" draggable="true" ondragstart="dragHandler(event)" class="ghost-drag">Drag and drop
                import</div>
        </div>

        <div class="tab-panel" id="tab-vr">
            <div class="panel-card">
                <div class="card-head">
                    <div>
                        <h2>VR Streamer</h2>
                        <p class="muted" id="vrStatusText">Waiting for server...</p>
                    </div>
                    <div class="status-refresh">
                        <span class="vr-status-pill offline" id="vrStatusChip">
                            <span class="status-dot mismatch"></span>
                            <span id="vrStatusLabel">Offline</span>
                        </span>
                        <button class="pill-btn" id="btn-vr-refresh-preview">Reload Preview</button>
                        <button class="pill-btn" id="btn-vr-check">Check Server</button>
                    </div>
                </div>

                <div class="vr-preview-grid">
                    <div class="vr-preview-panel">
                        <div class="card-head" style="margin-bottom: 0;">
                            <div>
                                <h3>Panel Preview</h3>
                                <p class="muted">MJPEG feed (Program Monitor crop)</p>
                            </div>
                        </div>
                        <div class="vr-preview-display">
                            <img id="vrPreviewImage" alt="VR preview stream">
                            <div class="vr-crop-overlay disabled" id="vrCropOverlay">
                                <div class="vr-crop-selection hidden" id="vrCropSelection">
                                    <div class="vr-crop-center-line"></div>
                                    <div class="vr-crop-handle handle-nw" data-handle="nw"></div>
                                    <div class="vr-crop-handle handle-ne" data-handle="ne"></div>
                                    <div class="vr-crop-handle handle-sw" data-handle="sw"></div>
                                    <div class="vr-crop-handle handle-se" data-handle="se"></div>
                                </div>
                            </div>
                            <div class="vr-preview-overlay" id="vrPreviewOverlay">Waiting for server...</div>
                        </div>
                    </div>
                    <div class="vr-preview-panel">
                        <div class="card-head" style="margin-bottom: 0;">
                            <div>
                                <h3>Headset Client</h3>
                                <p class="muted">A-Frame WebXR page</p>
                            </div>
                        </div>
                        <div class="vr-preview-display">
                            <iframe id="vrFrame" title="VR client"></iframe>
                            <div class="vr-preview-overlay" id="vrFrameOverlay">Server URL not set</div>
                        </div>
                    </div>
                </div>

                <div class="panel-grid">
                    <div class="panel-card" style="background: #252525;">
                        <h3>Server Control</h3>
                        <div class="vr-config-grid">
                            <label>Server URL
                                <input type="text" id="vrServerUrl" placeholder="http://localhost:5000">
                            </label>
                            <label>Mode
                                <select id="vrMode">
                                    <option value="region">Region (crop)</option>
                                    <option value="monitor">Full monitor</option>
                                </select>
                            </label>
                            <label>FPS
                                <input type="number" id="vrFps" min="1" max="60">
                            </label>
                            <label>Quality
                                <input type="number" id="vrQuality" min="10" max="95">
                            </label>
                        </div>
                        <div class="vr-button-row">
                            <button class="queue-btn" id="btn-start-server">Start Server (uv)</button>
                            <button class="queue-btn ghost" id="btn-open-server-folder">Open Server Folder</button>
                            <button class="queue-btn alt" id="btn-open-browser">Open in Browser</button>
                            <button class="pill-btn" id="btn-vr-save-host">Save Settings</button>
                        </div>
                        <div class="vr-meta">
                            <span>Launch script: <code>python_server/start_server.bat</code></span>
                            <span>Local IP: <code id="vrLocalIp">-</code></span>
                        </div>
                    </div>

                    <div class="panel-card" style="background: #252525;">
                        <h3>Capture Region (relative to monitor origin)</h3>
                        <div class="vr-config-grid">
                            <label>Monitor
                                <select id="vrMonitorIndex"></select>
                            </label>
                            <label>Top (px)
                                <input type="number" id="vrTop" min="0">
                            </label>
                            <label>Left (px)
                                <input type="number" id="vrLeft" min="0">
                            </label>
                            <label>Width (px)
                                <input type="number" id="vrWidth" min="1">
                            </label>
                            <label>Height (px)
                                <input type="number" id="vrHeight" min="1">
                            </label>
                        </div>
                        <div class="vr-aspect-row">
                            <label>
                                <input type="checkbox" id="vrAspectLock">
                                <span>Maintain 2:1 crop (SBS)</span>
                            </label>
                            <span class="vr-aspect-note">Adds a center guide for quick alignment.</span>
                        </div>
                        <div class="vr-button-row">
                            <button class="pill-btn" id="btn-vr-seq-dims">Use Sequence Size</button>
                            <button class="queue-btn" id="btn-vr-apply">Send Settings to Server</button>
                        </div>
                        <p class="muted" id="vrConfigStatus">Adjust offsets so the crop matches the Program
                            Monitor window.</p>
                    </div>

                    <div class="panel-card" style="background: #252525;">
                        <h3>Steps</h3>
                        <ol style="font-size: 12px; color: #ccc; padding-left: 20px; line-height: 1.6;">
                            <li>Ensure <code>uv</code> is installed and click <strong>Start Server</strong>.
                            </li>
                            <li>Wait for the status above to turn green, then fine-tune the capture region.</li>
                            <li>Put on your headset and open the browser.</li>
                            <li>Visit <code id="local-ip-display">http://&lt;YOUR_PC_IP&gt;:5000</code> (or the
                                server URL you set).</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div id="flow-pick-modal" class="confirm-modal">
        <div class="modal-content">
            <h2>Load A Flow File?</h2>
            <p>Picking a different Flow JSON will replace the current selection and reload the Showflow view. Make sure any open work is saved before continuing.</p>
            <div class="modal-actions">
                <button class="controlBg textStyle" id="flowPickCancel">Keep Current Flow</button>
                <button class="controlBg textStyle" id="flowPickConfirm">Pick Flow JSON</button>
            </div>
        </div>
    </div>
</body>

</html>
